<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dungeon World Chat - Sector 404</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        /* Base Styles & Mobile-First Design */
        body {
            background-color: #050505;
            color: #f0f0f0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding: 10px;
            max-width: 850px;
            margin: auto;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            transition: background-color 0.5s ease;
            padding-top: 50px; /* Space for ticker */
        }

        /* Digital Dungeon Grid Background */
        .dungeon-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 200%;
            height: 200%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='hexagons' fill='%231a1a1a' fill-opacity='1' fill-rule='nonzero'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.98-7.5V0h-2v6.35L0 12.69v2.3zm0 18.5L10.98 40v6.35h2V37.5L0 30v3.5zm30 0L17.02 37.5V49h2v-7.65l10.98-6.35V33.5zM30 15L19.02 8.65V0h-2v7.5L30 15z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            z-index: -2; /* Behind everything */
            animation: grid-drift 60s linear infinite;
            pointer-events: none;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        @keyframes grid-drift {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-28px, -49px); }
        }

        /* Achievement Box & Glitch Effect */
        .system-ai {
            background: linear-gradient(180deg, #990000 0%, #300000 100%);
            border: 4px solid #ff4500;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 0 30px #ff4500;
            transition: all 0.5s ease;
            position: relative;
            z-index: 1;
        }

        .glitch { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .header {
            color: #ffcc00;
            font-weight: bold;
            font-size: 1.8em;
            text-transform: uppercase;
            text-shadow: 2px 2px #000;
            line-height: 1.1;
            cursor: pointer;
            user-select: none;
            font-family: 'Share Tech Mono', monospace;
            transition: color 0.5s ease;
        }

        /* Crawler ID Style - Updated for prominence */
        .crawler-id-text {
            font-family: 'Share Tech Mono', monospace;
            color: #ffcc00;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            letter-spacing: 1px;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(255, 69, 0, 0.5);
            padding-bottom: 10px;
            transition: color 0.5s ease, border-color 0.5s ease;
        }

        /* Rarity Classes */
        .rarity-common { border-color: #888; box-shadow: 0 0 15px #888; }
        .rarity-legendary { border-color: #ff8c00; box-shadow: 0 0 25px #ff8c00; }
        .rarity-celestial { border-color: #00ffff; box-shadow: 0 0 30px #00ffff; }

        .achievement {
            color: #fff;
            font-size: 1.5em;
            font-weight: bold;
            margin: 10px 0;
            border-bottom: 2px solid #ff4500;
            padding-bottom: 5px;
            font-family: 'Share Tech Mono', monospace;
            transition: border-color 0.5s ease;
        }
        .ai-snark { color: #ffa500; font-style: italic; font-weight: bold; font-size: 1.1em; line-height: 1.4; }

        /* Chat UI */
        .chat-window { border: 2px solid #444; background: rgba(20, 20, 20, 0.95); padding: 12px; min-height: 400px; transition: all 0.5s ease; position: relative; z-index: 1; }
        .chat-entry { margin-bottom: 10px; padding: 15px; border-radius: 6px; font-size: 1em; line-height: 1.5; opacity: 0; }

        /* Animation for Chat Entries */
        .fade-in {
            animation: fadeInUp 0.5s ease forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Character Colors */
        .donut { border-left: 6px solid #ff69b4; background: #2b121e; }
        .mordecai { border-left: 6px solid #00d4ff; background: #121c2b; }
        .quasar { border-left: 6px solid #ffcc00; background: #2b2512; }
        .cascadia { border-left: 6px solid #32cd32; background: #0f2b15; } /* Lime Green */
        .prepotente { border-left: 6px solid #fdfd96; background: #2b2b12; }
        .katia { border-left: 6px solid #00ffff; background: #122b2b; }
        .odette { border-left: 6px solid #9932cc; background: #2b122b; } 
        .elle { border-left: 6px solid #98fb98; background: #122b1b; } 
        .florin { border-left: 6px solid #daa520; background: #2b2212; } 
        .zev { border-left: 6px solid #ff1493; background: #2b121c; }
        .bautista { border-left: 6px solid #e67300; background: #2b1d12; }
        .samantha { border-left: 6px solid #ff00cc; background: #2b0022; } /* Candy Purple/Pink */
        .louis { border-left: 6px solid #4682b4; background: #0f1b26; } /* Steel Blue */

        .username { font-weight: bold; display: block; margin-bottom: 5px; text-transform: uppercase; font-size: 0.9em; font-family: 'Share Tech Mono', monospace; letter-spacing: 0.5px; }
        .donut .username { color: #ff69b4; }
        .mordecai .username { color: #00d4ff; }
        .quasar .username { color: #ffcc00; }
        .cascadia .username { color: #32cd32; }
        .prepotente .username { color: #fdfd96; }
        .katia .username { color: #00ffff; }
        .odette .username { color: #9932cc; }
        .elle .username { color: #98fb98; }
        .florin .username { color: #daa520; }
        .zev .username { color: #ff1493; }
        .bautista .username { color: #e67300; }
        .samantha .username { color: #ff00cc; }
        .louis .username { color: #4682b4; }

        /* Floor Status */
        .floor-status { margin-top: 25px; padding: 15px; border-left: 6px solid #ffcc00; background: #221e00; font-size: 1em; transition: all 0.5s ease; position: relative; z-index: 1; }
        .status-header { color: #ffcc00; font-weight: bold; display: block; margin-bottom: 10px; text-transform: uppercase; font-family: 'Share Tech Mono', monospace; font-size: 1.2em; }
        .status-list { list-style: none; padding: 0; margin: 0; }
        .status-list li { margin-bottom: 8px; font-family: 'Share Tech Mono', monospace; }

        /* Footer & Buttons */
        .node-footer { margin-top: 40px; border: 2px solid #00ff00; padding: 20px; text-align: center; background: #000; transition: border-color 0.5s ease; position: relative; z-index: 1; }
        .button {
            display: block; width: 100%; box-sizing: border-box; margin-top: 15px; padding: 18px;
            background-color: #00ff00; color: #000; font-weight: bold; text-decoration: none;
            text-transform: uppercase; font-size: 1.2em; border-radius: 4px; border: none; cursor: pointer;
            transition: all 0.5s ease;
            font-family: 'Share Tech Mono', monospace;
        }
        .button:active { opacity: 0.7; }
        .button:disabled { background-color: #333; color: #666; cursor: not-allowed; }

        /* Share Options Styles */
        #share-options { display: none; margin-top: 15px; }
        .share-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .share-btn { margin: 0 !important; flex: 1; min-width: 80px; padding: 12px !important; font-size: 0.9em !important; color: white !important; }

        /* Blinking Cursor for Voodoo Header */
        .blinking-cursor::after {
            content: '_';
            animation: blink 1s step-end infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* NFC Hint Style */
        .nfc-hint {
            margin-top: 20px;
            padding: 12px;
            border: 2px solid #ffcc00;
            background: #221a00;
            color: #ffcc00;
            font-weight: bold;
            text-align: center;
            font-size: 0.9em;
            animation: pulse-warning 2s infinite;
            font-family: 'Share Tech Mono', monospace;
            position: relative; 
            z-index: 1;
        }
        @keyframes pulse-warning { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* Ticker Styles */
        .ticker-wrap {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #111;
            border-bottom: 2px solid #ff4500;
            overflow: hidden;
            height: 35px;
            line-height: 35px;
            z-index: 990; /* Below toggle buttons */
            transition: border-color 0.5s ease;
        }

        .ticker {
            display: inline-block;
            white-space: nowrap;
            padding-left: 100%;
            animation: ticker 900s linear infinite; 
            color: #ffcc00;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.9em;
        }

        @keyframes ticker {
            0% { transform: translate3d(0, 0, 0); }
            100% { transform: translate3d(-100%, 0, 0); }
        }

        /* Easter Egg Overlay */
        #easter-egg-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            color: #ff0000;
            font-family: 'Share Tech Mono', monospace;
            border: 5px solid #ff0000;
            box-sizing: border-box;
        }

        /* Sparkle Container for Donut Mode */
        .sparkle-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 998; /* Below toggles but above background */
            display: none; /* Hidden by default */
            overflow: hidden;
        }

        body.donut-theme .sparkle-container {
            display: block;
        }

        /* Hide grid when donut mode is active */
        body.donut-theme .dungeon-background {
            opacity: 0;
        }

        .sparkle {
            position: absolute;
            top: -10%;
            color: #ffd700; /* Gold */
            text-shadow: 0 0 5px #ff69b4; /* Pink glow */
            animation: fall linear infinite;
            user-select: none;
        }

        @keyframes fall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
        }

        /* --- DONUT MODE STYLES --- */
        body.donut-theme {
            background-color: #1a0515;
            color: #ffccff;
        }

        body.donut-theme .system-ai {
            background: linear-gradient(180deg, #660033 0%, #33001a 100%);
            border-color: #ff69b4;
            box-shadow: 0 0 30px #ff69b4;
        }

        body.donut-theme .header {
            color: #ff69b4;
            text-shadow: 2px 2px #330033;
        }

        body.donut-theme .crawler-id-text {
            color: #ff99cc;
            border-bottom-color: #ff1493;
        }

        body.donut-theme .achievement {
            border-bottom-color: #ff69b4;
        }

        body.donut-theme .ai-snark {
            color: #ff99cc;
        }

        body.donut-theme .chat-window {
            border-color: #ff69b4;
            background: rgba(40, 10, 30, 0.95);
        }

        /* Override "Live System Chat" inline colors */
        body.donut-theme .username[style*="#00ff00"] {
            color: #ff69b4 !important;
        }

        body.donut-theme .username[style*="#32cd32"] { /* Override Cascadia's green */
            color: #ff69b4 !important;
        }

        /* Override Floor Status */
        body.donut-theme .floor-status {
            border-left-color: #ff69b4 !important; 
            background: #2b0015 !important;
        }

        body.donut-theme .status-header {
            color: #ff69b4 !important;
        }
        
        body.donut-theme #level-timer {
            color: #ff1493 !important;
        }

        body.donut-theme .nfc-hint {
            border-color: #ff69b4;
            background: #2a0e2a;
            color: #ff69b4;
        }

        /* Override Footer & Buttons */
        body.donut-theme .node-footer {
            border-color: #ff69b4;
        }

        body.donut-theme .node-footer strong {
            color: #ff69b4 !important;
        }

        body.donut-theme .button {
            background-color: #ff69b4 !important;
            color: #000000 !important; /* Changed to Black for readability */
        }

        /* Override Panic Meter in Donut Mode */
        body.donut-theme #panic-bar {
            border-color: #ff69b4 !important;
        }
        body.donut-theme #panic-text {
            color: #ff69b4 !important;
        }
        body.donut-theme #gen-container {
             background: #2b0015 !important;
             border-color: #ff69b4 !important;
             border-style: dashed;
        }

        /* Override Voodoo Board in Donut Mode */
        body.donut-theme #voodoo-board-container {
             border-color: #ff69b4 !important;
        }
        body.donut-theme #voodoo-header {
             color: #ff69b4 !important;
        }
        body.donut-theme #voodoo-board-container button {
             border-color: #ff69b4 !important;
             color: #000000 !important; /* Black text for buttons */
             background-color: #ff69b4 !important;
        }
        body.donut-theme #voodoo-board-container input,
        body.donut-theme #voodoo-board-container textarea {
             border-color: #ff69b4 !important;
             color: #ff69b4 !important;
        }
        body.donut-theme #voodoo-feed {
            border-color: #ff69b4 !important;
            color: #ffccff !important;
        }
        body.donut-theme #voodoo-feed span[style*="#ffcc00"] {
            color: #ff69b4 !important;
        }
        body.donut-theme #char-count {
            color: #ff69b4 !important;
        }

        /* Override Ticker in Donut Mode */
        body.donut-theme .ticker-wrap {
            border-bottom-color: #ff69b4;
            background: #2a0e2a;
        }
        body.donut-theme .ticker {
            color: #ffccff;
        }

        @media (min-width: 600px) {
            body { padding: 30px; padding-top: 60px; }
            .header { font-size: 2.2em; }
            .achievement { font-size: 1.8em; }
            .button { width: auto; display: inline-block; padding: 15px 40px; }
        }
    </style>
</head>
<body>
    
    <!-- System Ticker -->
    <div class="ticker-wrap">
        <div class="ticker" id="system-ticker"></div>
    </div>
    
    <!-- Digital Dungeon Grid -->
    <div class="dungeon-background"></div>

    <!-- Sparkle Container -->
    <div id="sparkle-container" class="sparkle-container"></div>

    <!-- Theme Toggle -->
    <button id="theme-toggle" onclick="window.toggleDonutMode()" title="Toggle Donut Mode" style="position: fixed; top: 45px; right: 15px; z-index: 999; font-size: 2em; background: none; border: none; cursor: pointer; filter: drop-shadow(0 0 5px #000);">üï∂Ô∏è</button>

    <div id="easter-egg-overlay">
        <h1 style="font-size: 3em; margin-bottom: 10px;">!!! GLITCH DETECTED !!!</h1>
        <p style="font-size: 1.5em; color: #fff;">CARL! YOU'VE UNLOCKED: GOD-TIER CRAWLER STATUS!</p>
        <p style="font-size: 1.2em; font-style: italic; color: #888; margin-top: 20px;">(Nothing actually changed. Mordecai is still disappointed.)</p>
        <button onclick="window.closeEasterEgg()" class="button" style="background: #ff0000; color: #fff; margin-top: 30px;">RESUME SIMULATION</button>
    </div>

    <div class="system-ai">
        <div id="crawler-id" class="crawler-id-text">[ ID: UNKNOWN ]</div>
        <div class="header" onclick="window.trackHeaderTaps()">!!! NEW ACHIEVEMENT !!!</div>
        <div class="achievement" id="main-achievement-title">"CON-FLOOR SURVIVOR"</div>
        <p id="main-achievement-body">YOU DID IT! You‚Äôve successfully navigated the <strong>ATLANTA SKYBRIDGE GAUNTLET</strong>! You have survived the humidity, the smell of burnt rubber and expensive polyester, and the sheer, unadulterated chaos of sixty-thousand humans trying to occupy the same square inch of hotel carpet!</p>
        <p id="main-ai-snark" class="ai-snark">REWARD: You‚Äôve received a [Platinum] Badge Ribbon! It grants you +5 to Crowd Maneuvering and -10 to Personal Space. GET BACK TO THE MESH!</p>
    </div>

    <!-- FULL CHARACTER CHAT (Dynamic) -->
    <div class="chat-window">
        <span class="username" style="color: #00ff00; display: block; margin-bottom: 10px; font-size: 1.2em;" id="live-chat-header">[ LIVE SYSTEM CHAT ]</span>
        <div id="character-feed" aria-live="polite">
            <!-- JS will populate this -->
        </div>
    </div>

    <!-- LIVE STATUS BLOCK -->
    <div class="floor-status">
        <span class="status-header">[ LIVE FLOOR STATUS: SECTOR ATLANTA ]</span>
        <ul class="status-list" aria-live="polite">
            <li>‚è≥ LEVEL COLLAPSE IN: <span id="level-timer" style="color: #ff0000; font-weight: bold; font-family: 'Share Tech Mono', monospace;">CALCULATING...</span></li>
            <li id="status-row-1">üî∏ SCANNING SECTOR...</li>
            <li id="status-row-2">üî∏ SCANNING SECTOR...</li>
            <li id="status-row-3">üî∏ SCANNING SECTOR...</li>
        </ul>
    </div>

    <!-- Prepotente Panic Meter -->
    <div class="floor-status" style="border-left-color: #fdfd96; margin-top: 15px;">
        <span class="status-header" id="panic-header">[ PREPOTENTE PANIC METER ]</span>
        <div id="panic-bar" style="height: 30px; background: #111; border: 2px solid #fdfd96; position: relative; overflow: hidden; margin-top: 10px;">
            <div id="panic-fill" style="height: 100%; background: linear-gradient(90deg, #fdfd96, #ff0000); width: 85%; transition: width 1s;"></div>
        </div>
        <p id="panic-text" style="font-size: 0.9em; margin-top: 8px; color: #fdfd96; font-weight: bold; text-transform: uppercase; font-family: 'Share Tech Mono', monospace;">‚ö†Ô∏è CURRENT STATUS: AAAAAAHHHHH!</p>
    </div>

    <!-- NFC HINT -->
    <div class="nfc-hint" id="nfc-hint">
        [ SYSTEM WARNING: PROXIMITY SCAN DETECTED. TAP CHIP FOR UNSTABLE DATA UPLOAD ]
    </div>

    <div id="gen-container" class="system-ai" style="margin-top: 30px; border-style: dashed; background: #220000;">
        <div id="custom-header" class="header" style="font-size: 1.4em;">SYSTEM READY...</div>
        <div id="custom-title" class="achievement">"TAP FOR FATE"</div>
        <p id="custom-body" style="font-size: 1em;">Generate a useless achievement based on your level of survival.</p>

        <button onclick="window.generateAchievement()" class="button" style="background-color: #ff4500; color: white;">GENERATE ACHIEVEMENT</button>

        <div id="share-options">
            <p style="font-size: 0.9em; color: #ffcc00; margin-bottom: 10px; font-family: 'Share Tech Mono', monospace;">BRAG TO THE FEED:</p>
            <div class="share-grid">
                <button class="button share-btn" onclick="window.shareX()" style="background: #000;">X</button>
                <button class="button share-btn" onclick="window.shareBlueSky()" style="background: #0085ff;">BlueSky</button>
                <button class="button share-btn" onclick="window.shareThreads()" style="background: #444;">Threads</button>
                <button class="button share-btn" onclick="window.shareNative()" style="background: #e1306c;">Share...</button>
                <button class="button share-btn" onclick="window.copyToClipboard(event)" style="background: #00ff00; color: #000;">Copy</button>
            </div>
        </div>
    </div>

    <!-- Voodoo Board -->
    <div class="chat-window" style="margin-top: 25px; border-color: #00ff00; margin-bottom: 25px;" id="voodoo-board-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span class="username blinking-cursor" style="color: #00ff00; margin: 0; font-size: 1.2em;" id="voodoo-header">[ VOODOO BOARD ]</span>
            <button onclick="window.loadVoodooMessages(this)" style="background: none; border: 1px solid #00ff00; color: #00ff00; font-size: 0.8em; padding: 4px 10px; cursor: pointer; font-family: 'Share Tech Mono', monospace;">REFRESH</button>
        </div>
        
        <div id="voodoo-feed" style="height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; background: #000; padding: 10px; font-family: 'Share Tech Mono', monospace; font-size: 1.1em; border: 1px solid #333; margin-bottom: 15px; color: #00ff00; line-height: 1.5;" aria-live="polite">
            SYSTEM: INITIALIZING VOODOO FEED...
        </div>

        <div style="display: flex; flex-direction: column; gap: 8px;">
            <input type="text" id="voodoo-name" maxlength="25" placeholder="[ CRAWLER DESIGNATION ]" style="background: #111; border: 1px solid #00ff00; color: #00ff00; padding: 14px; font-family: 'Share Tech Mono', monospace; width: 100%; box-sizing: border-box; font-size: 1.1em;">
            
            <div style="position: relative;">
                <textarea id="voodoo-msg" maxlength="150" oninput="window.updateCharCount(this)" placeholder="[ UNENCRYPTED BURST TRANSMISSION ]&#10;[ MAX 150 CHARS - KEEP IT PG OR GET ACCELERATED ]" style="background: #111; border: 1px solid #00ff00; color: #00ff00; padding: 14px; padding-bottom: 25px; font-family: 'Share Tech Mono', monospace; height: 100px; width: 100%; box-sizing: border-box; resize: none; font-size: 1.1em;"></textarea>
                <span id="char-count" style="position: absolute; bottom: 8px; right: 10px; font-size: 0.8em; color: #00ff00; font-family: 'Share Tech Mono', monospace;">150</span>
            </div>

            <button onclick="window.postToVoodoo()" class="button" style="margin: 0; padding: 16px; font-size: 1.1em;">[ BROADCAST TO SECTOR ]</button>
        </div>
    </div>

    <!-- MESH NETWORK FOOTER (MOVED TO BOTTOM) -->
    <div class="node-footer">
        <strong style="color: #00ff00; font-family: 'Share Tech Mono', monospace; font-size: 1.2em;">[ DRAGON CON MESH ACTIVE ]</strong><br>
        <span style="color: #888; font-family: 'Share Tech Mono', monospace;">NODE ID: !1fcff30a</span><br>
        <a href="https://meshtastic.org/v/#CIrmv_4BElAKCSExZmNmZjMwYRIPb2JpLXdhbi1rZW1lc2hpGgRmMzBhIgbFMx_P8wooWEIgx5cjLfBcMK-Y-ZG_cuCi_jPojvkJoYq-P1lXSvX0YHxIAA" class="button">JOIN THE MESH</a>
        <div style="margin-top: 20px;">
            <a href="mailto:hbar98@gmail.com" style="color: #666; font-family: 'Share Tech Mono', monospace; text-decoration: none; font-size: 0.9em;">[ CONTACT SYSADMIN ]</a>
        </div>
    </div>

    <script>
        window.currentTitle = "";
        window.chatQueue = []; 
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx7ljyRllZ4a0OYp3B7Nrfw3Bn3QUMsXrUtJ44RlnDUk9fL8I0AyeocNrw1jXLbnDK6wg/exec';
        const FAVICON_SYSTEM = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23000000'/><path fill='%23ffffff' d='M35,20 L55,20 C55,20 60,50 80,65 C85,68 88,72 85,76 C82,80 75,80 70,80 L35,80 C25,80 28,65 30,50 Z'/><circle cx='80' cy='72' r='3' fill='%23000000'/></svg>";
        const FAVICON_DONUT = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%232a0e2a'/><path fill='%23ffd700' d='M20,60 L80,60 L90,30 L70,50 L50,10 L30,50 L10,30 Z'/><circle cx='50' cy='10' r='6' fill='%23ff69b4'/><circle cx='10' cy='30' r='4' fill='%23ff69b4'/><circle cx='90' cy='30' r='4' fill='%23ff69b4'/></svg>";

        // Ticker Messages (Randomized on Load)
        const SYSTEM_UPDATES = [
          "[SYSTEM PATCH v404.1] Fixed crawler exploit: No more duplicating badge ribbons in skybridge lobbies. Carl, we see you.",
          "[SYSTEM PATCH v404.2] Nerfed 'Humidity Debuff' by 12%‚Äîviewers complained about excessive sweating ASMR. Prepotente still whines.",
          "[SYSTEM PATCH v404.3] Added new achievement: 'Con-Floor Survivor'‚Äî+5 to Crowd Dodge, -10 to Personal Space. Donut approves.",
          "[SYSTEM PATCH v404.4] Emergency hotfix: Elevators now respawn 20% slower. Blame the fire marshal boss encounter.",
          "[SYSTEM PATCH v404.5] Buffed Mongo's 'Tiara Rage' ability‚Äînow shreds vendor booths. Princess Donut petitions granted.",
          "[SYSTEM PATCH v404.6] Removed 'Free Sample Mimic' from food court. 47 crawlers consumed. Apologies to Florin.",
          "[SYSTEM PATCH v404.7] Quasar Legal Update: Class-action nerf to overpriced water vendors. Hydration is now a right.",
          "[SYSTEM PATCH v404.8] Patch notes for patch notes: Fixed AI snark overflow. Mordecai remains disappointed.",
          "[SYSTEM PATCH v404.9] New floor boss: 'The Eternal Line'‚Äîeternal taunt immunity required. Katia, your tank strat OP.",
          "[SYSTEM PATCH v404.10] Donut Mode activated site-wide: +20% sass, pink filters mandatory. Mongo demands tribute.",
          "[SYSTEM PATCH v404.11] Fixed Voodoo Board ghosting‚Äîmessages now persist. No more 'transmission failed' exploits.",
          "[SYSTEM PATCH v404.12] Nerfed Prepotente Panic Meter: Now caps at 95% to prevent server sobs. Mother unavailable.",
          "[SYSTEM PATCH v404.13] Added Mesh Network integration: +10% signal in Hyatt lobbies. Join or perish.",
          "[SYSTEM PATCH v404.14] Emergency buff: 'Con-Crud Resistance Potion' now craftable from pizza boxes. Elle tested.",
          "[SYSTEM PATCH v404.15] Carl Exploit Closed: Foot photos no longer grant god-tier framing kits. Footage scrubbed.",
          "[SYSTEM PATCH v404.16] Odette Showrunner Note: Elevator Fail arc trending‚Äîextended by 48 hours for ratings.",
          "[SYSTEM PATCH v404.17] Fixed achievement generator RNG: 'Sticky Skybridge' now 100% useless as advertised.",
          "[SYSTEM PATCH v404.18] Casandra Ops Patch: Sector Atlanta entity cap raised to 85k. Maintain formation, idiots.",
          "[SYSTEM PATCH v404.19] Zev Marketing Buff: Share buttons now grant +1 viewer engagement. Brag responsibly.",
          "[SYSTEM PATCH v404.20] Growler Gary Cameo: Left Hand Whiskey restocked. 14 donations appreciated.",
          "[SYSTEM PATCH v404.21] Level collapse timer accuracy: Now syncs to Labor Day 5PM. Pack your respawn kit.",
          "[SYSTEM PATCH v404.22] Nerfed carpet hypnosis: 'DO NOT STARE' warning now voice-activated. Saves lives.",
          "[SYSTEM PATCH v404.23] Princess Donut Petition: Tiara booths upgraded to celestial. Mongo chomps approved.",
          "[SYSTEM PATCH v404.24] Quasar Sues Patch: Waivers rewritten‚Äîcrawlers own the fine print now.",
          "[SYSTEM PATCH v404.25] Fixed panic bar overflow: No more 'AAAAAHHHHH!' server crashes. Prepotente muted temporarily.",
          "[SYSTEM PATCH v404.26] New rare drop: 'Priority Elevator Pass (Still Broken)'. Collect 'em all!",
          "[SYSTEM PATCH v404.27] AI Snark Rotation: 47 new Carl roasts added. Feet photos remain copyrighted.",
          "[SYSTEM PATCH v404.28] Voodoo Board Expansion: PG-13 filter strengthened. [REDACTED] transmissions accelerated.",
          "[SYSTEM PATCH v404.29] Final Warning: Skybridge Gauntlet loot table rotated. Survive or reset.",
          "[SYSTEM PATCH v404.30] Buffed 'Badge Line Bypass' exploit‚Äînow requires actual stealth. Carl, your feet won't cut it here.",
          "[SYSTEM WARNING v404.31] WARNING: TAKE A SHOWER. YOU HUMANS ARE DISGUSTING. CON-CRUD SPREADING‚ÄîDONUT'S FUR IS NOT A TOWEL.",
          "[SYSTEM PATCH v404.32] Nerfed shuttle void: Lost crawlers now respawn in the lobby. Florin, no more walkabouts.",
          "[SYSTEM WARNING v404.33] WARNING: HYDRATE OR DIE. PIZZA IS NOT WATER, DESPITE WHAT ELLE CLAIMS AFTER MIDNIGHT.",
          "[SYSTEM PATCH v404.34] Added 'Chaotic Good Vibe' aura‚Äî+15% to parade survival. Prepotente exempt due to panic incompatibility.",
          "[SYSTEM WARNING v404.35] WARNING: DO NOT STARE AT THE CARPET. IT STARES BACK. MORDECAI'S THERAPY BILLS ARE SKYROCKETING.",
          "[SYSTEM PATCH v404.36] Fixed Quasar's lawsuit loop: Bricks can no longer be sued. Occupancy concepts pending review.",
          "[SYSTEM WARNING v404.37] WARNING: ELEVATORS ARE A TRAP. USE STAIRS, FATTIES. CARL, YOUR EXPLOSIVE FEET MIGHT HELP‚ÄîOR NOT.",
          "[SYSTEM PATCH v404.38] Buffed panic text rotation: Now includes 'MOTHERRR!' variants. Viewers love the drama.",
          "[SYSTEM WARNING v404.39] WARNING: NO RED CARPET IN LOBBY? UNACCEPTABLE! DONUT DEMANDS UPGRADES‚ÄîOR MONGO EATS YOUR COSPLAY.",
          "[SYSTEM PATCH v404.40] Nerfed humidity swamp: Debuff now stacks slower. Odette thanks you for the 'sweaty arc' ratings.",
          "[SYSTEM WARNING v404.41] WARNING: BODY PAINT LEVELS CRITICAL. SYSTEM DETECTING DANGEROUS SMEARS‚ÄîWASH OFF BEFORE YOU MELT.",
          "[SYSTEM PATCH v404.42] Added Growler Gary Easter Egg: Whiskey drops now 5% more left-handed. 14 respawns not included.",
          "[SYSTEM WARNING v404.43] WARNING: SLEEP IS OPTIONAL, BUT NOT FOR HUMANS. PASS OUT IN A FUR SUIT? RESPAWN AS CON-CRUD BOSS.",
          "[SYSTEM PATCH v404.44] Fixed Voodoo profanity filter: [REDACTED] now auto-accelerates. Keep it PG, crawlers.",
          "[SYSTEM WARNING v404.45] WARNING: CROWD MANEUVERING REQUIRED. +5 TO DODGE, OR GET TRAMPLED BY THE SAME COSPLAY 47 TIMES.",
          "[SYSTEM PATCH v404.46] Buffed achievement rarity: Celestial tiaras now 1% drop rate. Donut's grudging respect included.",
          "[SYSTEM WARNING v404.47] WARNING: AIR QUALITY ALERT‚ÄîCON-CRUD DETECTED. MASK UP OR BECOME A GHOUL MOB. KATIA, TANK IT.",
          "[SYSTEM PATCH v404.48] Nerfed fire marshal boss: Table flips now 20% less dramatic. Casandra approves formation.",
          "[SYSTEM WARNING v404.49] WARNING: OVERPRICED WATER? EXTORTION! QUASAR SUES HYDRATION‚ÄîBUT YOU STILL NEED TO DRINK, IDIOTS.",
          "[SYSTEM PATCH v404.50] Added Mongo photo op: Signed drops now grant +10 to adorable chomps. Princess demands credit.",
          "[SYSTEM WARNING v404.51] WARNING: THE SUN IS YOUR ENEMY. SURFACE TEMPERATURES RISING‚ÄîSTAY IN THE VOID, CRAWLERS.",
          "[SYSTEM PATCH v404.52] Fixed status rotator: 'SCREAMING VIBE' now audible. Zev says it polls well with Valtay.",
          "[SYSTEM WARNING v404.53] WARNING: HOT GLUE FAILURE IMMINENT. COSPLAY INTEGRITY AT 50%‚ÄîREPAIR OR EXPOSE YOUR SHAME.",
          "[SYSTEM PATCH v404.54] Buffed share options: Bragging now grants minor loot boxes. Don't tell Mordecai.",
          "[SYSTEM WARNING v404.55] WARNING: BADGE LINE CIRCLING BLOCK‚ÄîETERNAL. WITHER AND PERISH, OR USE THE MESH BYPASS.",
          "[SYSTEM PATCH v404.56] Nerfed room line wrap: Now only around the building once. Eternal variant pending.",
          "[SYSTEM WARNING v404.57] WARNING: 3AM WAFFLE HOUSE BOSS ACTIVE. SCATTERED, SMOTHERED, COVERED‚ÄîOR DIE TRYING.",
          "[SYSTEM PATCH v404.58] Added Easter egg overlay: God-tier status now includes actual nothing. Disappointment buffed.",
          "[SYSTEM WARNING v404.59] WARNING: DECORATIVE POTPOURRI IS NOT OATS. CARL, STOP EATING IT. PREPOTENTE MELTDOWN IN 3...2..."
        ];

        // Donut Mode Toggle Logic
        window.toggleDonutMode = function(forceState) {
            // Apply theme toggle
            if (typeof forceState !== 'undefined') {
                if (forceState) document.body.classList.add('donut-theme');
                else document.body.classList.remove('donut-theme');
            } else {
                document.body.classList.toggle('donut-theme');
            }

            // Save state to localStorage
            const isDonut = document.body.classList.contains('donut-theme');
            localStorage.setItem('donutMode', isDonut);

            // Update UI elements based on state
            const header = document.querySelector('.system-ai .header');
            const mainTitle = document.getElementById('main-achievement-title');
            const mainBody = document.getElementById('main-achievement-body');
            const snark = document.querySelector('#main-ai-snark');
            const voodooHeader = document.getElementById('voodoo-header');
            const chatHeader = document.getElementById('live-chat-header');
            const panicHeader = document.getElementById('panic-header');
            const nfcHint = document.getElementById('nfc-hint');
            const favicon = document.getElementById('dynamic-favicon');
            
            // Generator Elements
            const genTitle = document.getElementById('custom-title');
            const genBody = document.querySelector('#gen-container p'); // Target the p inside container
            const genBtn = document.querySelector('#gen-container button');

            if (isDonut) {
                // Header / Intro
                header.innerText = "üëë MONGO'S FAN CLUB üëë";
                mainTitle.innerText = '"OFFICIAL CLUB MEMBER"';
                mainBody.innerHTML = "CONGRATULATIONS! YOU HAVE BEEN SELECTED TO WORSHIP ME AND MONGO! THIS IS THE HIGHEST HONOR AVAILABLE IN THIS DUNGEON. TRY NOT TO EMBARRASS US BY WEARING CROCS. MONGO IS JUDGING YOUR FASHION CHOICES.";
                snark.innerText = "REWARD: ACCESS TO EXCLUSIVE BEHIND-THE-SCENES FOOTAGE OF ME BEING PERFECT. YOU'RE WELCOME!";
                snark.style.color = "#ff99cc";
                
                // Sections
                voodooHeader.innerText = "[ PRINCESS DONUT'S ROYAL FAN CLUB ]";
                chatHeader.innerText = "[ THE ROYAL GOSSIP FEED ]";
                panicHeader.innerText = "[ MONGO APPALL-O-METER ]";
                nfcHint.innerText = "[ ROYAL ALERT: TAP CHIP FOR AN EXCLUSIVE MUSICAL PERFORMANCE! ]";
                
                // Generator
                genTitle.innerText = '"CONSULT THE QUEEN"';
                genBody.innerText = "Receive a royal judgment on your convention performance.";
                genBtn.innerText = "RECEIVE ROYAL EDICT";
                
                if(favicon) favicon.href = FAVICON_DONUT;
                window.startSparkles();
            } else {
                // Header / Intro
                header.innerText = "!!! NEW ACHIEVEMENT !!!";
                mainTitle.innerText = '"CON-FLOOR SURVIVOR"';
                mainBody.innerHTML = "YOU DID IT! You‚Äôve successfully navigated the <strong>ATLANTA SKYBRIDGE GAUNTLET</strong>! You have survived the humidity, the smell of burnt rubber and expensive polyester, and the sheer, unadulterated chaos of sixty-thousand humans trying to occupy the same square inch of hotel carpet!";
                
                // Restore random snark if switching back, unless page just loaded
                if (typeof forceState === 'undefined') {
                    const randomSnark = AI_SNARKS[Math.floor(Math.random() * AI_SNARKS.length)];
                    snark.innerText = `REWARD: ${randomSnark}`;
                }
                snark.style.color = "#ffa500";
                
                // Sections
                voodooHeader.innerText = "[ VOODOO BOARD ]";
                chatHeader.innerText = "[ LIVE SYSTEM CHAT ]";
                panicHeader.innerText = "[ PREPOTENTE PANIC METER ]";
                nfcHint.innerText = "[ SYSTEM WARNING: PROXIMITY SCAN DETECTED. TAP CHIP FOR UNSTABLE DATA UPLOAD ]";
                
                // Generator
                genTitle.innerText = '"TAP FOR FATE"';
                genBody.innerText = "Generate a useless achievement based on your level of survival.";
                genBtn.innerText = "GENERATE ACHIEVEMENT";

                if(favicon) favicon.href = FAVICON_SYSTEM;
                window.stopSparkles();
            }
            
            // Re-init meters/stats immediately to switch status text/colors
            window.initPanicMeter();
            window.initLiveStats();
        };

        // Crawler ID Logic
        window.initCrawlerID = function() {
            let id = localStorage.getItem('crawlerID');
            if (!id) {
                // Generate random ID: #100,000 to #999,999
                id = '#' + Math.floor(Math.random() * 900000 + 100000).toLocaleString();
                localStorage.setItem('crawlerID', id);
            }
            // Update display
            const idDisplay = document.getElementById('crawler-id');
            if(idDisplay) {
                 idDisplay.innerText = `WELCOME, CRAWLER ${id}`;
            }
        };

        // Random Snark Array
        const AI_SNARKS = [
            "Carl, stop looking at that booth. We have a schedule!",
            "THE ELEVATORS ARE STILL BROKEN, CARL!",
            "Princess Donut demands you acknowledge Mongo immediately.",
            "Prepotente is having a meltdown in 3... 2... 1...",
            "I've detected 47 people wearing the same cosplay. This is a nightmare.",
            "Carl, those aren't oats. Please stop eating the decorative potpourri.",
            "Mordecai wants you to know he's very disappointed in your choices.",
            "SYSTEM: Detecting dangerous levels of body paint and humidity.",
            "Carl, look at the feet on these people! WHY DO YOU DO THIS TO ME?!"
        ];

        // Dynamic Chat Data
        const CHAT_CHARACTERS = [
            {
                id: 'donut',
                name: 'Princess Donut (Grand Champion)',
                lines: [
                    "CARL! MONGO IS APPALLED! WHY ARE ALL THESE PEOPLE LOOKING AT A MAN IN A SPANDEX ONESIE? TELL THE NETWORK ADMIN TO BROADCAST MY IMAGE ON EVERY SCREEN IN THE HYATT IMMEDIATELY!",
                    "CARL! THIS CARPET PATTERN IS AN ASSAULT ON MY SENSES! IT CLASHES WITH MY BOA! TELL MANAGEMENT TO REPLACE IT WITH SOMETHING IN A NICE PASTE!",
                    "CARL! THIS 'DIRTY SHIRLEY' TASTES LIKE COUGH SYRUP! FIX IT! AND GET MONGO A CHICKEN TENDER! HE IS WASTING AWAY!",
                    "ZEV SAYS MY 'HOTEL LOBBY STRUT' IS TRENDING! CARL, CLEAR A PATH! I NEED TO WAVE TO MY ADORING FANS! STOP BLOCKING MY LIGHT!",
                    "IS THAT SUPPOSED TO BE ME? THAT TORTOISESHELL PATTERN IS ALL WRONG! AND MONGO WOULD NEVER WEAR POLYESTER! IT IS AN INSULT TO THE CROWN!",
                    "WHY IS EVERYONE SWEATING? IT IS DISGUSTING. MORDECAI, MAKE THE AIR CONDITIONING COLDER! USE YOUR MANAGER POWERS!",
                    "CARL! THAT ROBOT JUST BEEPED AT ME! IS IT A BOMB? IT'S PROBABLY A BOMB. MONGO, DESTROY IT!",
                    "I AM THE QUEEN OF THIS CONVENTION! WHY IS THERE NO RED CARPET IN THE LOBBY? UNACCEPTABLE! I REFUSE TO WALK ON THIS FLOOR!",
                    "CARL! SIGNET SAYS SHE FOUND A BOOTH WITH CATNIP. WE ARE GOING THERE. NOW! PUSH THESE PEASANTS OUT OF THE WAY!",
                    "I HAVE BEEN STANDING HERE FOR FIVE MINUTES AND NO ONE HAS OFFERED ME A TREAT. THIS DUNGEON IS BROKEN. I WANT TO SPEAK TO THE AI!"
                ]
            },
            {
                id: 'prepotente',
                name: 'Prepotente (Level 51 Caprid)',
                lines: [
                    "AAAAAAAAAAHHHHHH! MOTHER! THE ELEVATORS ARE A BORANT CONSPIRACY! THEY WANT US TO STARVE ON THE SKYBRIDGE!",
                    "THAT MAN IN THE FUR SUIT IS MOCKING MY ANCESTRY! I AM A CAPRID, NOT A 'FURRY'! MOTHER, SMITE HIM!",
                    "I DEMAND TO SPEAK TO THE DUNGEON ADMIN! THIS 'BADGE PICKUP' QUEUE IS A TORTURE CHAMBER! AAAAAAAAAAHHHHHH!",
                    "AAAAAAAAAAHHHHHH! THE AIR IS LIQUID! MY WOOL IS DAMP! MOTHER, WHY HAVE YOU FORSAKEN ME TO THIS SWAMP CITY?",
                    "TO THE PEASANT WHO OFFERED ME A 'SLIM JIM': I REQUIRE ARTISANAL OATS! DO NOT INSULT MY PALATE WITH PROCESSED MEAT STICKS!",
                    "AAAAAAAAAAHHHHHH! I AM TRAPPED IN A SEA OF ELVES! THEY ARE TOUCHING MY ROBE! MOTHER, SEND BIANCA TO CLEAR A PATH!",
                    "CARL! YOU COLOSSAL DOLT! YOU SAID THIS WAS A 'PARTY'! THIS IS JUST STANDING IN LINE WITH EXTRA STEPS! AAAAAAAAAAHHHHHH!",
                    "THE NOISE! IT IS WORSE THAN THE SCREAMING GOAT SHOW! MAKE IT STOP! AAAAAAAAAAHHHHHH!",
                    "MIRIAM SAYS I CANNOT EAT THE CARPET. BUT IT SMELLS LIKE DESPAIR AND OLD BEER. I WANT TO TASTE THE DESPAIR! MOTHER!",
                    "I HAVE BEEN WALKING FOR DAYS AND I AM STILL IN THE SAME HOTEL! THE GEOMETRY IS NON-EUCLIDEAN! AAAAAAAAAAHHHHHH!"
                ]
            },
            {
                id: 'katia',
                name: 'Katia (Level 46 Doppelg√§nger)',
                lines: [
                    "I think I just accidentally joined a cult in the gaming hall. They gave me a ribbon. Is 'Pathfinder' a deity? I should probably hide this from Donut.",
                    "Accidentally joined a LARP group in the lobby; they thought my tank build was cosplay. Now I'm committed. Does a program booklet count as a shield?",
                    "Bautista is trying to tame the plushies in the Vendor Hall. If you see a Tigran negotiating with a Squishmallow, please just keep walking.",
                    "I saw three other people wearing my face today. I didn't shapeshift, I swear. This con is confusing.",
                    "The crowd density on the skybridge is critical. I'm popping a shield. Get behind me if you want to reach the Marriott alive.",
                    "Donut keeps trying to 'unionize' the volunteers. Carl, we need to move before she starts a revolution. Again.",
                    "My constitution is high, but this 'Con-Crud' debuff is aggressive. Wash your hands, or I'm not healing you.",
                    "Security zip-tied my sword. It feels naked. How am I supposed to hold aggro with a peace-bonded weapon?",
                    "I tried to find a Safe Room, but I ended up in a panel about 'Fanfiction Tropes'. It was... educational? I think?",
                    "That mural in the Artist Alley has terrible composition. The perspective is all wrong. Oh god, it's moving. Never mind."
                ]
            },
            {
                id: 'mordecai',
                name: 'Mordecai (Princess Donut\'s Manager)',
                lines: [
                    "That blue drink isn't a mana potion, Carl. It's just sugar and cheap grain alcohol. ...Get me one. Double.",
                    "Donut, put the 'shiny thing' down. That is a vendor's paperweight, not a Celestial artifact. We cannot afford the looting penalty.",
                    "I've analyzed the pathing of the crowds in the Marriott. It's a classic herd-thinning mechanic. Stay near the walls or you'll get trampled.",
                    "If I see Odette with a camera crew, we are leaving. I don't care if you're in line for a photo op. We are *gone*.",
                    "You call this a 'Safe Room'? There are three thousand people here, the noise level is deafening, and the air quality is toxic. I'm going back to the Desperado Club.",
                    "Prepotente is actually right about one thing: these elevators are a death trap. I'd rather take my chances with a floor boss than that cable tension.",
                    "I'm brewing a cure for 'Con-Crud' in the hotel sink. It smells like sulfur and rot, but it works better than your Earth medicine. Drink up.",
                    "Stop asking me if I can shapeshift into a dragon for the parade. My contract specifically forbids unauthorized spectacles. Also, dragons are tacky.",
                    "Carl, that 'Peace Bonding' zip-tie on your weapon is flimsy. One good tug and we're ready for combat. Keep it hidden.",
                    "I used to run a guild hall for thousands of crawlers. This... 'Dealer's Den'... is significantly more cutthroat. Watch your pockets."
                ]
            },
            {
                id: 'quasar',
                name: 'Quasar (Attorney at Law)',
                lines: [
                    "I HAVE REVIEWED THE TERMS OF SERVICE ON THIS BADGE! CLAUSE 4 IS UNENFORCEABLE! I OWN THE FINE PRINT NOW! I OWN YOU!",
                    "THIS ELEVATOR CAPACITY IS A SAFETY VIOLATION! IF WE CRASH, I AM SUING GRAVITY! I AM SUING SIR ISAAC NEWTON PERSONALLY!",
                    "TWENTY DOLLARS FOR A PRETZEL? THIS IS PREDATORY PRICING! I AM DRAFTING AN INJUNCTION AGAINST THE FOOD COURT AS WE SPEAK!",
                    "YOU THERE! THAT COSTUME INFRINGES ON AT LEAST THREE COPYRIGHTS! CEASE AND DESIST OR I WILL CONFISCATE YOUR FOAM ARMOR!",
                    "THE ATMOSPHERIC CONTROLS IN THIS SKYBRIDGE VIOLATE THE GENEVA CONVENTION! I WILL SUE THE HVAC SYSTEM INTO OBLIVION!",
                    "I REPRESENT CRAWLER #4,122! I DO NOT REPRESENT YOU! GET OUT OF MY WAY OR I WILL BILL YOU FOR THIS CONVERSATION!",
                    "WAITING IN LINE IS A THEFT OF BILLABLE HOURS! I AM CHARGING THE CONVENTION ORGANIZERS 500 GOLD PER MINUTE!",
                    "THIS CROWD DENSITY IS A FIRE HAZARD! I AM FILING A MOTION TO DISPERSE THIS MOJITO PARTY IMMEDIATELY!",
                    "THAT VENDOR SOLD ME A DEFECTIVE MYSTERY BOX! THIS IS FRAUD! I WILL OWN HIS INVENTORY! I WILL OWN HIS ANCESTORS!",
                    "FINALLY, A MESH NETWORK THAT ADHERES TO PROTOCOL! IF THE SIGNAL DROPS, I AM SUING THE ELECTROMAGNETIC SPECTRUM!"
                ]
            },
            {
                id: 'cascadia',
                name: 'Cascadia (Executive Producer)',
                lines: [
                    "HELLO, CRAWLERS! Welcome to the ultimate thrill ride in Sector Atlanta! The badge pickup is buzzing with energy‚Äîlines primed for epic waits! Every moment builds the hype! Now get out there and queue, queue, queue!",
                    "GOOD MORNING, CRAWLERS! The elevators are your gateway to adventure‚Äîoperational and ready for glory! Debuffs? Just fuel for the fire! Stay super hydrated and charge ahead! Now line up with gusto and queue, queue, queue!",
                    "ATTENTION, CRAWLERS! Skybridge gauntlet alert: Humidity at maximum thrill levels‚Äîfeel the rush! The parade route is electric! Push through with style and dominate! Now form those legendary lines and queue, queue, queue!",
                    "HELLO AGAIN, CRAWLERS! Panel rooms are hotspots of excitement‚Äîfilling up fast with star power! Every delay is a chance for massive alliances! Forge ahead, champions! Now join the action and queue, queue, queue!",
                    "CRAWLERS! Food court extravaganza: Pizza lines are the battleground of legends‚Äîgrab your slice of victory! Survival never tasted so good! Avoid those sneaky mimics and triumph! Now hustle with hunger and queue, queue, queue!",
                    "GOOD AFTERNOON, PARTICIPANTS! Vendor hall mania: Booths overflowing with loot‚Äîcrowds fueling the frenzy! This is prime time for grabs! Seize the swag with flair! Now dive in and queue, queue, queue!",
                    "SPECIAL UPDATE, CRAWLERS! Shuttle void challenge: Navigate the haze like pros‚Äîmesh bypass activated! Hype levels peaking! Use it to soar! Now fall in with full force and queue, queue, queue!",
                    "HELLO, CRAWLERS! Cosplay contest spectacular: Outfits shining brighter than stars‚Äîglue holding strong! Style points galore! Strut your stuff, superstars! Now embrace the spotlight and queue, queue, queue!",
                    "CRAWLERS! Evening power-up: Con-crud? No match for your unstoppable spirit‚Äîmask up and conquer! Every breath is a win! Charge through the arc! Now join the unstoppable masses and queue, queue, queue!",
                    "FINAL BRIEFING, CRAWLERS! Sector pop at max thrill‚Äîchaos turned to pure gold! The fire marshal? Just another epic boss! Push on with unbreakable energy! Now embrace the glory and queue, queue, queue!"
                ]
            },
            {
                id: 'odette',
                name: 'Odette (Galactic Press)',
                lines: [
                    "Smile, darlings! You're live on the *After Hours* feed. Try not to look so... mortal. The Valtay love a tragedy, but they prefer it in high definition.",
                    "The engagement metrics on this 'Elevator Line' subplot are plummeting. Someone start a fight or kiss a goblin. I have ad slots to fill!",
                    "I‚Äôm seeing a lot of unauthorized merch in the Dealer's Den. I hope you all saved 15% for the Borant Corporation, or the hunter-killers will be deployed shortly.",
                    "Can we get a better lighting rig in the Hyatt? The shadows are drowning out the despair. Viewers need to *see* the sweat, people!",
                    "This 'walking around aimlessly' arc is boring. Where is the conflict? Where is the betrayal? I need a plot twist before the commercial break!",
                    "I've just sold the exclusive rights to the 'Hotel Lobby Con-Crud Outbreak' arc. Don't disappoint my sponsors. If you're going to pass out, do it dramatically.",
                    "We're losing the 18-34 demographic in the Dealer's Den. Someone knock over a display case! I need action!",
                    "This panic attack is brought to you by the Borant Corporation. Remember to smile while you scream, darlings!",
                    "Polls are open! Should we double the humidity or spawn an elite mob in the food court? Vote with your bits!",
                    "That 'heroic sacrifice' holding the elevator door? Polling terribly. Next time, let it close. It's better drama.",
                    "I love the despair in your eyes, but could you angle it towards camera two? The lighting is much better."
                ]
            },
            {
                id: 'elle',
                name: 'Elle (Level 44 Cryomancer)',
                lines: [
                    "Yo, barkeep! This 'potion' tastes like watered-down goblin spit. Hit me with something that burns, or I'm freezing your taps.",
                    "I spent ten years in a wheelchair staring at a wall. Now I can freeze the moisture in your eyeballs. Keep walking, honey.",
                    "See that guy in the spandex? Reminds me of my Barry, if Barry had glutes you could bounce a quarter off of. I might just say hello.",
                    "You push Donut one more time, and you're gonna find out what absolute zero feels like. Spoiler: It hurts the whole time you're dying.",
                    "This line is longer than the wait for pudding at Meadow Lark. Move it along before I turn this whole hallway into a slip-and-slide.",
                    "It is hot as hell in this atrium. I'm about to cast a blizzard just to cool down. You're welcome in advance, sweat-bags.",
                    "Hey, tall, dark, and armored. You busy later? I got a bottle of Knockout and low standards. Let's make some bad decisions.",
                    "Accidentally icicled a vendor because he wouldn't give me the senior discount. Oops. No remorse.",
                    "Imani is freaking out about the crowds again. I'm gonna go build her an ice fortress. Anyone tries to get in, they get the pointy end.",
                    "My Barry would've loved this place. All the weirdos in one spot. He'd have been staring at the booth babes, the old goat. I miss him."
                ]
            },
            {
                id: 'florin',
                name: 'Florin (Level 52 Mercenary)',
                lines: [
                    "Oi, watch your six in the Dealer's Den. It's tighter than a goblin tunnel in there. Perfect spot for an ambush.",
                    "To the muppet who asked if I'm from Paris: I will feed you your own lanyard. I'm Australian.",
                    "Ife... she would have loved this chaos. The colors, the noise. I'm just here to make sure the rest of you survive.",
                    "Security tried to peace-bond my Mossberg. Cute. Like a zip-tie stops a magical shotgun.",
                    "That queue for the ballroom is a tactical nightmare. Chock-a-block. We need a breach charge to get through.",
                    "Fair dinkum, fifty credits for a slice of pizza? I've done wet work for less than a combo meal.",
                    "I'm holding the perimeter at the Marriott bar. If you see the rest of the Flower Children, send 'em my way.",
                    "This humidity... reminds me of the jungle. Keep your powder dry and your water bottles full.",
                    "Don't trust the elevators. They're a coffin waiting to drop. We take the stairs. Move.",
                    "If you need a backup gun, I'm yours. I owe Carl that much. Just point me at the problem."
                ]
            },
            {
                id: 'zev',
                name: 'Zev (Social Media Manager)',
                lines: [
                    "Omigod, did you see that group in the lobby? It‚Äôs giving total *Gossip Girl* Season 2 vibes! I need a picture for the blog!",
                    "Carl, stop scowling at the camera! You‚Äôre trending down with the Valtay demographic. We need 'Heroic Stoicism,' not 'Create a Union' energy!",
                    "I am technically not allowed to tell you this, but the 'water' in the green room is recycled waste. Do not drink it. I sent you a care package.",
                    "Donut! The engagement numbers on your 'Judging Cosplayers' segment are huge! Keep being mean, the viewers love it!",
                    "My boss is monitoring this channel, so I definitely *cannot* tell you that the elevator on the left is a mimic. (Wink).",
                    "Ugh, the Borant executives are freaking out about the property damage in the Vendor Hall. Can you maybe *not* blow up a booth for like, five minutes?",
                    "I tried to get you a sponsorship with the Pizza Vendor, but they saw what Mongo did to the buffet table. The deal is off.",
                    "Focus group results are in: Fans love the 'Exhausted Dad' vibe, Carl. Lean into it. Carry Donut more. It tests well with the Havok faction.",
                    "Is that a *Riverdale* jacket? I am screaming! I hate this job! Take me with you when you ascend!",
                    "We are live in ten seconds! Fix your hair! Hide the explosives! Smile like you aren't traumatized! And... action!"
                ]
            },
            {
                id: 'bautista',
                name: 'Bautista (Level 56 Swashbuckler)',
                lines: [
                    "To the person asking if I am a 'Furry': I am a Tigran warrior. This is not a costume. And no, you cannot pet the tail.",
                    "Katia, I have secured a table in the food court. It was a battle, but the curved sword proved persuasive. I am brewing tea.",
                    "I am at the plushie booth in the Vendor Hall. These creatures... they are feral. I must tame them before they hurt someone.",
                    "I pray for the souls of those stuck in the Marriott elevator line. It is a trial of faith greater than any dungeon floor.",
                    "Do not touch the Beanie Baby on my shoulder. He is primed to explode. You have been warned.",
                    "The structural integrity of this 'Marriott' is questionable. If the floor boss attacks, aim for the support pillars. I have marked them.",
                    "I will defend this line until my last breath. Or until Katia tells me we can leave.",
                    "I have acquired a 'Squishmallow'. It is soft. It will make a devastating proximity mine.",
                    "Katia, stay close. That man in the inflatable T-Rex suit is moving with suspicious intent. I am ready to intercept.",
                    "I am meditating near the fire exit. If the 'Con-Crud' spreads to this sector, we detonate the hallway and seal it off."
                ]
            },
            {
                id: 'samantha',
                name: 'Samantha (The Head)',
                lines: [
                    "I SAW A WOMAN WITH WHITE HAIR IN THE LOBBY! IS THAT MOTHER? LOUIS, RUN FASTER! I MUST KILL HER!",
                    "THIS ELEVATOR SMELLS OF DESPAIR AND CHEAP LATEX! IT REMINDS ME OF THE NOTHING! I HATE IT!",
                    "YOU! YES, YOU IN THE SPANDEX! DO YOU KNOW KING BLAINE? TELL HIM I AM HERE AND I AM FURIOUS!",
                    "CARL! WHY ARE WE STOPPING? I DO NOT CARE ABOUT 'BADGE PICKUP'! I CRAVE VIOLENCE AND FUNNEL CAKE!",
                    "THAT MAN DRESSED AS A CLOWN MOCKED ME! I WILL FLAY HIS MIND! I WILL KILL HIS MOTHER!",
                    "I AM A GODDESS OF UNREQUITED LOVE! AND THIS VENDING MACHINE ACCEPTED MY MONEY BUT GAVE ME NO SNACK! IT IS A CRUEL METAPHOR!",
                    "LOUIS! DON'T PUT ME IN THE BAG! I CAN'T BREATHE IN THE BAG! I WANT TO SEE THE CONFETTI!",
                    "THESE MORTALS ARE WEAK! THEY COMPLAIN OF 'WALKING'. TRY ROLLING AROUND AS A HEAD FOR ETERNITY!",
                    "IS THAT A SAND OOZE? MRS. GHAZI?! oh... no... it is just a spilled slushie. I AM WEEPING!",
                    "THE FIRE MARSHAL TRIED TO STOP ME! I TOLD HIM I WOULD CONSUME HIS SOUL! HE LET US PASS!"
                ]
            },
            {
                id: 'louis',
                name: 'Louis (Level 54 Extermination Pro)',
                lines: [
                    "Yeah, so the line for badges is currently longer than the entire Iron Tangle. Cool. Real cool. Anyone got a deck of cards or should I just stare at the carpet until my soul leaves?",
                    "Princess just declared this entire vendor hall her kingdom. Again. I'm not even mad anymore. I'm just... tired. Someone pass me a water that isn't $8.",
                    "Carl's over there trying to 'strategize' around the skybridge crowd like it's a floor boss. Bro, it's just 60,000 people who all want the same Funko Pop. We're doomed.",
                    "I saw Prepotente lose it because someone stepped on his tail. Again. At this point I'm pretty sure the con-crud is airborne panic spores. I'm wearing two masks.",
                    "Donut's demanding a red carpet in the Marriott lobby. Security said no. She said 'Mongo disagrees.' I give it ten minutes before the fire marshal shows up.",
                    "The humidity here is so bad my phone keeps fogging up. Mordecai would be proud. 'Drink water,' he says. Yeah, if I can find any that isn't $12 a bottle.",
                    "Elle just froze a guy's drink solid because he cut in line. I didn't see anything. Nope. Not a thing. I'm just here for the free samples and emotional support.",
                    "Florin keeps muttering about 'dodgy queues' and 'daylight robbery.' Mate, we're all in the same hell. At least the carpet's consistent‚Äîstill staring at me.",
                    "Zev's trying to get me to pose for a sponsor shot next to a trash can. 'It's gritty,' she says. Yeah, gritty like my life choices right now. Pass.",
                    "Look, if the elevators break one more time I'm walking the stairs. All the way to the top. With full gear. Because apparently that's less painful than waiting. Send help. Or pizza. Mostly pizza."
                ]
            }
        ];

        window.headerTapCount = 0;
        window.tapTimer = null;

        window.trackHeaderTaps = function() {
            window.headerTapCount++;
            clearTimeout(window.tapTimer);
            if (window.headerTapCount >= 5) {
                window.triggerEasterEgg();
                window.headerTapCount = 0;
            } else {
                window.tapTimer = setTimeout(() => { window.headerTapCount = 0; }, 2000);
            }
        };

        window.triggerEasterEgg = function() {
            document.body.classList.add('glitch');
            document.getElementById('panic-fill').style.width = '100%';
            document.getElementById('panic-text').innerText = "‚ö†Ô∏è SYSTEM CRITICAL: CARL IS CHEATING!";
            document.getElementById('easter-egg-overlay').style.display = 'flex';
        };

        window.closeEasterEgg = function() {
            document.body.classList.remove('glitch');
            document.getElementById('easter-egg-overlay').style.display = 'none';
            window.initPanicMeter();
        };

        window.chatInterval = null;
        
        window.initChatCycle = function() {
            const container = document.getElementById('character-feed');
            container.innerHTML = ''; 
            
            // Fill initial messages from the queue
            for(let i=0; i<4; i++) {
                window.addChatMessage();
            }

            // Start organic interval (random 7-12s)
            window.scheduleNextMessage();
        };
        
        // ADDED MISSING FUNCTION
        window.refillChatQueue = function() {
            window.chatQueue = [];
            // Loop through all characters and pick a random line
            CHAT_CHARACTERS.forEach(char => {
                 const randomLine = char.lines[Math.floor(Math.random() * char.lines.length)];
                 window.chatQueue.push({
                     id: char.id,
                     name: char.name,
                     text: randomLine
                 });
            });
            // Shuffle the queue
            window.chatQueue.sort(() => Math.random() - 0.5);
        };
        
        window.scheduleNextMessage = function() {
            if (window.chatInterval) clearTimeout(window.chatInterval);
            const delay = Math.floor(Math.random() * (12000 - 7000 + 1)) + 7000;
            window.chatInterval = setTimeout(() => {
                window.addChatMessage();
                window.scheduleNextMessage();
            }, delay);
        };

        window.addChatMessage = function() {
            // Check if queue is empty, if so refill and shuffle
            if (!window.chatQueue || window.chatQueue.length === 0) {
                window.refillChatQueue();
            }

            const container = document.getElementById('character-feed');
            const msg = window.chatQueue.pop(); // Get next unique message
            
            const entry = document.createElement('div');
            entry.className = `chat-entry ${msg.id} fade-in`;
            entry.innerHTML = `<span class="username">${msg.name}</span>${msg.text}`;
            
            container.appendChild(entry);
            
            // Limit to 5 visible messages
            if (container.children.length > 5) {
                container.removeChild(container.firstChild);
            }
        };

        window.onload = function() {
            // Populate Ticker
            const tickerEl = document.getElementById('system-ticker');
            // Shuffle array for randomness
            const shuffledUpdates = [...SYSTEM_UPDATES].sort(() => 0.5 - Math.random());
            // Join with a separator
            tickerEl.innerText = shuffledUpdates.join("   ///   ");

            // Apply random snark
            const randomSnark = AI_SNARKS[Math.floor(Math.random() * AI_SNARKS.length)];
            document.getElementById('main-ai-snark').innerText = `REWARD: ${randomSnark}`;

            // Initialize Crawler ID
            window.initCrawlerID();

            // Check for saved theme
            const savedTheme = localStorage.getItem('donutMode');
            if (savedTheme === 'true') {
                window.toggleDonutMode(true);
            }

            // Generate Dynamic Chat
            window.initChatCycle();
            
            // Auto-fill Crawler Designation from LocalStorage
            const savedName = localStorage.getItem('crawlerName');
            const crawlerID = localStorage.getItem('crawlerID');
            const voodooInput = document.getElementById('voodoo-name');

            if (savedName) {
                voodooInput.value = savedName;
            } else if (crawlerID) {
                // Auto-fill generated ID if no saved name
                voodooInput.value = `Crawler ${crawlerID}`;
            }

            // Init Dynamic Statuses
            setTimeout(function() {
                window.loadVoodooMessages();
                // FIXED: Wrapped in anonymous function so setInterval doesn't pass a timestamp
                setInterval(() => window.loadVoodooMessages(), 30000);
                
                window.initPanicMeter();
                window.initLiveStats();
            }, 500);
        };

        // Panic Meter Logic
        window.panicInterval = null;
        window.initPanicMeter = function() {
            if (window.panicInterval) clearInterval(window.panicInterval);
            const fill = document.getElementById('panic-fill');
            const text = document.getElementById('panic-text');
            const isDonut = document.body.classList.contains('donut-theme');
            
            // Separate Status Pools
            const prepotenteStatuses = [
                "AAAAAAHHHHH!",
                "ELEVATOR SABOTAGE!",
                "OATS DEPLETION!",
                "MOTHERRR!",
                "UNACCEPTABLE!",
                "CONTROLLED SOBBING",
                "THE SKYBRIDGE IS A TRAP!",
                "WHERE IS MY LANYARD?!",
                "TOO MANY PEOPLE!",
                "I REQUIRE PREMIUM OATS!",
                "THE CARPET IS MOVING!",
                "DIGNITY CRITICAL!"
            ];

            const mongoStatuses = [
                "THE LACK OF SNACKS",
                "YOUR CHEAP SHOES",
                "GRAVY BOAT",
                "THE BUFFET LINE",
                "THAT BADGE PHOTO",
                "PLASTIC TIARAS",
                "THE HUMIDITY",
                "THAT AWFUL WIG",
                "UNAUTHORIZED HEAD PATS",
                "THAT COCKER SPANIEL"
            ];

            window.panicInterval = setInterval(() => {
                // Range 60% to 100% for visible movement
                const newWidth = Math.floor(Math.random() * (100 - 60 + 1)) + 60;
                fill.style.width = newWidth + '%';
                
                // Pick a random status based on theme
                let randomStatus;
                if(isDonut) {
                      randomStatus = mongoStatuses[Math.floor(Math.random() * mongoStatuses.length)];
                      text.innerText = `ü¶ñ MONGO IS APPALLED BY: ${randomStatus}`;
                      
                      // Donut Mode Colors (Pink/Purple)
                      if (newWidth > 90) {
                         text.style.color = "#ff1493"; // Deep Pink
                         fill.style.background = "linear-gradient(90deg, #ff69b4, #ff1493)";
                      } else if (newWidth < 75) {
                         text.style.color = "#ffb6c1"; // Light Pink
                         fill.style.background = "linear-gradient(90deg, #ffb6c1, #ff69b4)";
                      } else {
                         text.style.color = "#ff69b4"; // Hot Pink
                         fill.style.background = "linear-gradient(90deg, #ff69b4, #ff1493)";
                      }

                } else {
                      // System Mode (Prepotente)
                      randomStatus = prepotenteStatuses[Math.floor(Math.random() * prepotenteStatuses.length)];
                      text.innerText = `üêê CURRENT STATUS: ${randomStatus}`;
                      
                      // System Mode Colors (Red/Yellow/Orange)
                      if (newWidth > 90) {
                         text.style.color = "#ff0000"; // Red
                         fill.style.background = "linear-gradient(90deg, #ff4500, #ff0000)";
                     } else if (newWidth < 75) {
                         text.style.color = "#fdfd96"; // Yellow
                         fill.style.background = "linear-gradient(90deg, #fdfd96, #ffcc00)";
                     } else {
                         text.style.color = "#ff8c00"; // Orange
                         fill.style.background = "linear-gradient(90deg, #ffcc00, #ff4500)";
                     }
                }
            }, 3000);
        };

        // Live Stats Logic (Dynamic Status Lines)
        window.statsInterval = null;
        window.statusRotationInterval = null;
        
        window.initLiveStats = function() {
            if (window.statsInterval) clearInterval(window.statsInterval);
            if (window.statusRotationInterval) clearInterval(window.statusRotationInterval);

            // Pool of random statuses for SYSTEM MODE
            const systemStatusPool = [
                { label: "ELEVATORS", value: "[CRITICAL FAILURE]", color: "#ff0000" },
                { label: "ELEVATORS", value: "FULL. ALWAYS FULL.", color: "#ffcc00" },
                { label: "TEMPERATURE", value: "SURFACE OF THE SUN", color: "#ff4500" },
                { label: "HUMIDITY", value: "SWAMP CONDITIONS", color: "#00ccff" },
                { label: "ROOM LINE", value: "ETERNAL", color: "#ff0000" },
                { label: "ROOM LINE", value: "WRAPPED AROUND BUILDING", color: "#ffcc00" },
                { label: "CURRENT BOSS", value: "THE FIRE MARSHAL", color: "#ff0000" },
                { label: "CURRENT BOSS", value: "3AM WAFFLE HOUSE", color: "#ffcc00" },
                { label: "CURRENT BOSS", value: "THE SUN", color: "#ffcc00" },
                { label: "SECTOR POP", value: "85,420 [OVERCROWDED]", color: "#ffcc00" },
                { label: "AIR QUALITY", value: "CON-CRUD DETECTED", color: "#00ff00" },
                { label: "HYDRATION", value: "PIZZA IS NOT WATER", color: "#00ccff" },
                { label: "SHUTTLE", value: "LOST IN THE VOID", color: "#ff0000" },
                { label: "CARPET", value: "DO NOT STARE", color: "#cc00ff" },
                { label: "VIBE", value: "SCREAMING", color: "#ff0000" },
                { label: "VIBE", value: "CHAOTIC GOOD", color: "#00ff00" },
                { label: "COSTUME", value: "HOT GLUE FAILURE", color: "#ffcc00" },
                { label: "BADGE LINE", value: "CIRCLING THE BLOCK", color: "#ff0000" },
                { label: "SLEEP", value: "OPTIONAL", color: "#00ccff" }
            ];

            // Pool of random statuses for DONUT MODE
            const donutStatusPool = [
                { label: "MONGO'S MOOD", value: "A GOOD BOY", color: "#ff69b4" },
                { label: "MONGO'S MOOD", value: "HANGRY", color: "#ff0000" },
                { label: "MONGO'S MOOD", value: "CHEWING ON COSPLAYER", color: "#ff1493" },
                { label: "GLITTER LEVEL", value: "BLINDING", color: "#ffccff" },
                { label: "GLITTER LEVEL", value: "EVERYWHERE", color: "#ff69b4" },
                { label: "FAN WORSHIP", value: "DEAFENING", color: "#ff1493" },
                { label: "FAN WORSHIP", value: "ACCEPTABLE", color: "#ff69b4" },
                { label: "CARL'S FEET", value: "STILL GROSS", color: "#8b4513" },
                { label: "TIARA SHINE", value: "MAXIMUM", color: "#ffd700" },
                { label: "TREAT SUPPLY", value: "CRITICALLY LOW", color: "#ff0000" },
                { label: "TREAT SUPPLY", value: "PLENTIFUL", color: "#00ff00" },
                { label: "NUGGETS", value: "ACQUIRED", color: "#00ff00" },
                { label: "HAVOK", value: "IMMINENT", color: "#ff4500" },
                { label: "SIGNET", value: "IN THE WAY", color: "#ff0000" },
                { label: "STYLE", value: "IMPECCABLE", color: "#ff69b4" }
            ];

            const updateStatuses = () => {
                const isDonut = document.body.classList.contains('donut-theme');
                const pool = isDonut ? donutStatusPool : systemStatusPool;
                
                // Update Header
                const statusHeader = document.querySelector('.floor-status .status-header');
                if(statusHeader) {
                    statusHeader.innerText = isDonut ? "[ ROYAL STATUS UPDATE ]" : "[ LIVE FLOOR STATUS: SECTOR ATLANTA ]";
                }

                // Shuffle and pick 3 unique items
                const shuffled = [...pool].sort(() => 0.5 - Math.random());
                const selected = shuffled.slice(0, 3);
                
                for(let i=0; i<3; i++) {
                    const el = document.getElementById(`status-row-${i+1}`);
                    if(el) {
                        el.innerHTML = `üî∏ ${selected[i].label}: <span style="color: ${selected[i].color}; font-weight: bold;">${selected[i].value}</span>`;
                    }
                }
            };

            // Run immediately and then rotate every 12 seconds
            updateStatuses();
            window.statusRotationInterval = setInterval(updateStatuses, 12000);

            // Level Collapse Timer Logic (Labor Day 5PM)
            const timerEl = document.getElementById('level-timer');
            const now = new Date();
            const year = now.getFullYear();
            
            // Calculate Labor Day (1st Monday of Sept)
            let laborDay = new Date(year, 8, 1); 
            while (laborDay.getDay() !== 1) {
                laborDay.setDate(laborDay.getDate() + 1);
            }
            laborDay.setHours(17, 0, 0, 0);

            // If passed, target next year
            if (now > laborDay) {
                laborDay.setFullYear(year + 1);
                laborDay.setMonth(8);
                laborDay.setDate(1);
                while (laborDay.getDay() !== 1) {
                    laborDay.setDate(laborDay.getDate() + 1);
                }
                laborDay.setHours(17, 0, 0, 0);
            }

            window.statsInterval = setInterval(() => {
                const currentTime = new Date().getTime();
                const distance = laborDay.getTime() - currentTime;

                if (distance < 0) {
                    timerEl.innerText = "COLLAPSE IMMINENT";
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                timerEl.innerText = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            }, 1000);
        };

        window.generateAchievement = function() {
            const isDonut = document.body.classList.contains('donut-theme');
            let adj, noun, vPast, vIng, body, reward, title;
            
            // MOVED THESE TO TOP SCOPE so they work in Donut Mode too
            const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
            const roll = Math.floor(Math.random() * 20); // Arbitrary large number or just use length later

            if (!isDonut) {
                // --- SYSTEM AI MODE (Expanded) ---
                const adjectives = [
                    "Legendary", "Decrepit", "Glistening", "Appalled", "Celestial", "Malfunctioning", "Stinky", 
                    "Exasperated", "Unhinged", "Copyright-Infringing", "God-Tier", "Sticky", "Slime-Covered", 
                    "Aggressive", "Radioactive", "Inverted", "Slightly-Moist", "Forbidden", "Glitchy", "Pixelated",
                    "Non-Euclidean", "Over-Encumbered", "Shattered", "Cursed", "Explosive"
                ];
                const nouns = [
                    "Skybridge", "Tiara", "Oats", "Packet", "Llama", "Cosplayer", "Holocron", "Badge", 
                    "Elevator", "Con-Crud", "Foot-Photo", "Vendor-Hall", "Service-Lift", "Lanyard", 
                    "Hot-Glue-Gun", "Safe-Room", "Drop-Rate", "Mob", "Trap", "Inventory-Slot", 
                    "Hotel-Key", "Energy-Drink", "Wig-Cap", "Prop-Weapon", "Queue-Line"
                ];
                const verbsPast = [
                    "wrangled", "evaded", "glurped", "sued", "screamed at", "infiltrated", "buffered", 
                    "ignored", "acquired", "over-clocked", "petted", "dismantled", "yeeted", "consumed", 
                    "traumatized", "hack-slashed", "loot-scooped", "accidentally deleted", "worshipped", "survived"
                ];
                const verbsIng = [
                    "wrangling", "evading", "glurping", "suing", "screaming at", "infiltrating", "buffering", 
                    "ignoring", "acquiring", "over-clocking", "petting", "dismantling", "yeeting", "consuming", 
                    "traumatizing", "hack-slashing", "loot-scooping", "accidentally deleting", "worshipping", "surviving"
                ];

                const rollIndex = Math.floor(Math.random() * verbsPast.length);

                adj = pick(adjectives);
                noun = pick(nouns);
                vPast = verbsPast[rollIndex];
                vIng = verbsIng[rollIndex];

                const article = /^[aeiou]/i.test(adj) ? "an" : "a";
                const isPlural = ["Oats", "Foot-Photo", "Badge-Ribbon"].includes(noun);
                const fullNoun = isPlural ? `${adj} ${noun}` : `${article} ${adj} ${noun}`;

                const bodies = [
                    `You have ${vPast} ${fullNoun} in a way that makes the AI very uncomfortable.`,
                    `Against all odds, you successfully ${vPast} ${fullNoun} without causing a sector-wide reset.`,
                    `By ${vIng} ${fullNoun}, you have officially peaked. It's all downhill from here.`,
                    `The AI noticed you ${vPast} ${fullNoun}. It's currently writing a creepy poem about it.`,
                    `You just ${vPast} ${fullNoun}. Mordecai is sighing so hard he might pass out.`,
                    `Warning: You have ${vPast} ${fullNoun}. This action has been logged for future blackmail.`,
                    `Achievement Unlocked: 'Why Did You Do That?'. You ${vPast} ${fullNoun}.`,
                    `You successfully ${vPast} ${fullNoun}. The Borant Corporation is now suing you.`
                ];

                reward = "A Common Quality Cotton Sock.";
                if (noun === "Tiara") reward = "Princess Donut's grudging respect.";
                else if (noun === "Oats") reward = "10 seconds of silence from Prepotente.";
                else if (noun === "Foot-Photo") reward = "A [God-Tier] digital framing kit.";
                else reward = pick([
                    "Priority Elevator Access (Still Broken).", 
                    "A Signed Photo of Mongo.", 
                    "+5 to Humidity Resistance.", 
                    "A commemorative pin that says 'I Tried'.", 
                    "A Loot Box containing nothing but disappointment.", 
                    "XP for a skill you don't even have.",
                    "The realization that you are insignificant.",
                    "A slightly damp sandwich from the vendor hall.",
                    "Immunity to Con-Crud (Duration: 5 minutes)."
                ]);
                
                body = pick(bodies);
                title = `"${adj} ${noun}"`;

            } else {
                // --- DONUT MODE (Expanded) ---
                const dAdjectives = [
                    "Sparkly", "Royal", "Inferior", "Acceptable", "Divine", "Glitzy", "Hideous", 
                    "Perfect", "Dazzling", "Unworthy", "Tacky", "Ghastly", "Magnificent", 
                    "Pedestrian", "Sublime", "Garish", "Fetch", "Basic", "Slay-Worthy"
                ];
                const dNouns = [
                    "Tiara", "Fan Club", "Paparazzi", "Selfie", "Treat", "Catnip", "Spotlight", 
                    "Cosplay", "Red Carpet", "Sunglasses", "Peasant", "Follower-Count", 
                    "Makeup-Kit", "Cat-Tree", "Cocktail", "Gossip", "Side-Eye", "Engagement-Metric", 
                    "Filter", "Hashtag"
                ];
                const dVerbsPast = [
                    "dazzled", "commanded", "outshined", "summoned", "judged", "blessed", 
                    "scolded", "ignored", "adopted", "critiqued", "banished", "improved", 
                    "yelled at", "overshadowed", "demanded", "influenced", "trended with"
                ];
                
                const rollIndex = Math.floor(Math.random() * dVerbsPast.length);

                adj = pick(dAdjectives);
                noun = pick(dNouns);
                vPast = dVerbsPast[rollIndex];
                
                const article = /^[aeiou]/i.test(adj) ? "an" : "a";
                const fullNoun = `${article} ${adj} ${noun}`;

                const dBodies = [
                    `MONGO IS PLEASED! You have ${vPast} ${fullNoun} with adequate style.`,
                    `Finally, someone who understands! You ${vPast} ${fullNoun} perfectly. Carl, take notes!`,
                    `I saw you ${vPast} ${fullNoun}. It was ALMOST as good as when I do it. Almost.`,
                    `You ${vPast} ${fullNoun}. The viewers love it! Our engagement metrics are spiking!`,
                    `Ugh. You ${vPast} ${fullNoun}? Really? Without glitter? Fix it immediately.`,
                    `Zev says you just ${vPast} ${fullNoun}. It's trending on the galactic feed!`,
                    `By ${vPast} ${fullNoun}, you have proven you aren't completely useless. Just mostly.`,
                    `Oh honey, you ${vPast} ${fullNoun}. It was brave. Not good, but brave.`
                ];

                reward = pick([
                    "Permission to look at me for 5 seconds.",
                    "A glitter bomb (It gets everywhere).",
                    "A 'Mongo Approved' sticker.",
                    "The honor of holding my sunglasses.",
                    "A shoutout on the chat (Maybe).",
                    "One (1) singular celestial treat.",
                    "A follow-back (Just kidding).",
                    "The privilege of blocking a hater.",
                    "A rhinestone collar (Human size).",
                    "My autograph (Signed by Carl)."
                ]);

                body = pick(dBodies);
                title = `"${adj.toUpperCase()} ${noun.toUpperCase()}"`;
            }

            const container = document.getElementById('gen-container');
            container.classList.remove('glitch', 'rarity-common', 'rarity-legendary', 'rarity-celestial');
            void container.offsetWidth; 
            container.classList.add('glitch');

            const rarity = (isDonut || Math.random() > 0.7) ? (Math.random() > 0.5 ? "rarity-legendary" : "rarity-celestial") : "rarity-common";
            container.classList.add(rarity);

            window.currentTitle = title; // Update global for sharing
            document.getElementById('custom-header').innerText = isDonut ? "ROYAL DECREE ISSUED!" : "NEW ACHIEVEMENT!";
            document.getElementById('custom-title').innerText = title;
            document.getElementById('custom-body').innerText = `${body}\n\nREWARD: ${reward}`;
            document.getElementById('share-options').style.display = 'block';
        };

        window.getShareText = function() {
            return `I just earned the "${window.currentTitle}" achievement at Dragon Con! Don't tell Mordecai: hbar98.github.io #DragonCon #DCC`;
        };

        window.shareX = function() { window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(window.getShareText())}`, '_blank'); };
        window.shareBlueSky = function() { window.open(`https://bsky.app/intent/compose?text=${encodeURIComponent(window.getShareText())}`, '_blank'); };
        window.shareThreads = function() { window.open(`https://www.threads.net/intent/post?text=${encodeURIComponent(window.getShareText())}`, '_blank'); };
        window.shareNative = function() {
             if (navigator.share) {
                navigator.share({
                    title: 'Dungeon World Chat',
                    text: window.getShareText(),
                    url: 'https://hbar98.github.io'
                }).catch(console.error);
            } else {
                // Fallback to copy if native share fails/isn't available
                const btn = event.target; // grab button from click
                btn.innerText = "COPIED!";
                navigator.clipboard.writeText(window.getShareText());
                setTimeout(() => { btn.innerText = "Share..."; }, 2000);
            }
        };

        window.copyToClipboard = function(e) {
            if (!navigator.clipboard) {
                const textArea = document.createElement("textarea");
                textArea.value = window.getShareText();
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const btn = e.target;
                    const originalText = btn.innerText;
                    btn.innerText = "COPIED!";
                    setTimeout(() => { btn.innerText = originalText; }, 2000);
                } catch (err) {}
                document.body.removeChild(textArea);
                return;
            }
            navigator.clipboard.writeText(window.getShareText()).then(() => {
                const btn = e.target;
                const originalText = btn.innerText;
                btn.innerText = "COPIED!";
                setTimeout(() => { btn.innerText = originalText; }, 2000);
            });
        };

        // Enhanced Profanity Filter
        window.sanitize = function(str) {
            if (!str) return "";
            let clean = str.replace(/<\/?[^>]+(>|$)/g, "");
            
            // Enhanced word list with common variants and leetspeak
            const blockedWords = [
                "fuck", "fuk", "fck", "f u c k", "sh!t", "shit", "sh1t", "bitch", "b!tch", "b1tch",
                "cunt", "twat", "wank", "pussy", "dick", "d1ck", "cock", "penis", "vagina",
                "asshole", "a$$hole", "bastard", "slut", "whore",
                "nazi", "n@zi", "racist", "fag", "f@g", "nigger", "nigga", "n1gger", "kike", "spic",
                "retard", "r3tard", "chink", "tranny", "shemale", "dyke", "gook", "beaner", "coon",
                "rapist", "pedophile", "pedo", "pdf file", "PDF file"
            ];
            
            blockedWords.forEach(word => {
                // Case-insensitive and catches variations with spaces/symbols
                const regex = new RegExp(word.split('').join('[\\s\\W]*'), "gi");
                clean = clean.replace(regex, "[REDACTED]");
            });
            
            // Enforce length limit
            return clean.trim().substring(0, 150);
        };

        window.updateCharCount = function(textarea) {
            const remaining = 150 - textarea.value.length;
            const counter = document.getElementById('char-count');
            counter.innerText = remaining;
            counter.style.color = remaining < 20 ? '#ff0000' : '#00ff00';
        };

        window.loadVoodooMessages = function(btnElement) {
            const feed = document.getElementById('voodoo-feed');
            
            // UI Feedback
            let originalText = "REFRESH";
            if (btnElement && btnElement.innerText) { // ADDED CHECK
                originalText = btnElement.innerText;
                btnElement.innerText = "...";
                btnElement.disabled = true;
            }

            // Don't wipe the feed if it already has content, to prevent flickering
            if(feed.children.length === 0 || feed.innerText.includes('SYSTEM:')) {
                 feed.innerHTML = 'SYSTEM: ACCESSING VOODOO STREAM...';
            }

            const cacheBuster = SCRIPT_URL + (SCRIPT_URL.includes('?') ? '&' : '?') + 't=' + new Date().getTime();
            fetch(cacheBuster, { method: "GET", redirect: "follow" })
            .then(res => {
                if (!res.ok) throw new Error('Network response not ok');
                return res.json();
            })
            .then(data => {
                // Clear and rebuild
                feed.innerHTML = '';
                if (data && Array.isArray(data)) {
                    data.reverse().forEach(row => {
                        const entry = document.createElement('div');
                        entry.style.marginBottom = "15px";
                        entry.style.borderBottom = "1px solid #222";
                        entry.style.paddingBottom = "8px";
                        const displayName = window.sanitize(row[1] || 'Unknown Designation');
                        const displayMsg = window.sanitize(row[2] || 'Empty Transmission');
                        entry.innerHTML = `<span style="color: #ffcc00; font-size: 0.9em; font-weight: bold;">[${displayName}]</span><br>${displayMsg}`;
                        feed.appendChild(entry);
                    });
                    if (data.length === 0) feed.innerHTML = 'SYSTEM: NO TRANSMISSIONS FOUND.';
                }
            })
            .catch(err => {
                console.error("Voodoo Load Error:", err);
                // Only show error if feed is empty
                if(feed.children.length === 0) {
                    feed.innerHTML = 'SYSTEM ERROR: CONNECTION INTERRUPTED.<br><br>Check browser console or verify Google Script deployment.';
                }
            })
            .finally(() => {
                if (btnElement && btnElement.innerText) { // ADDED CHECK
                    btnElement.innerText = originalText;
                    btnElement.disabled = false;
                }
            });
        };

        window.postToVoodoo = function() {
            const nameField = document.getElementById('voodoo-name');
            const msgField = document.getElementById('voodoo-msg');
            const name = window.sanitize(nameField.value) || 'Anonymous';
            const message = window.sanitize(msgField.value);
            if (!message) return;
            const btn = document.querySelector('button[onclick="window.postToVoodoo()"]');
            const originalText = btn.innerText;
            btn.innerText = "[ TRANSMITTING... ]";
            btn.disabled = true;

            // Save name to LocalStorage
            if (nameField.value.trim()) {
                localStorage.setItem('crawlerName', nameField.value.trim());
            }

            const formData = new URLSearchParams();
            formData.append('name', name);
            formData.append('message', message);
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData.toString()
            })
            .then(() => {
                msgField.value = '';
                // Reset char count
                document.getElementById('char-count').innerText = '150';
                btn.innerText = "[ BROADCAST SUCCESS ]";
                setTimeout(() => window.loadVoodooMessages(), 2000); 
                setTimeout(() => { 
                    btn.innerText = originalText; 
                    btn.disabled = false;
                }, 4000);
            })
            .catch(err => {
                console.error("Voodoo Post Error:", err);
                btn.innerText = "[ TRANSMISSION FAILED ]";
                btn.disabled = false;
                setTimeout(() => { btn.innerText = originalText; }, 3000);
            });
        };

        // Sparkle Functions for Donut Mode
        window.startSparkles = function() {
            const container = document.getElementById('sparkle-container');
            container.innerHTML = ''; // Clear
            const sparkleCount = 30; // Not too many
            
            for (let i = 0; i < sparkleCount; i++) {
                const sparkle = document.createElement('div');
                sparkle.classList.add('sparkle');
                sparkle.innerHTML = Math.random() > 0.5 ? '‚ú®' : '‚ú¶';
                sparkle.style.left = Math.random() * 100 + 'vw';
                sparkle.style.animationDuration = (Math.random() * 3 + 2) + 's'; // 2-5s
                sparkle.style.animationDelay = (Math.random() * 5) + 's';
                sparkle.style.fontSize = (Math.random() * 10 + 10) + 'px'; // 10-20px
                container.appendChild(sparkle);
            }
        };

        window.stopSparkles = function() {
            const container = document.getElementById('sparkle-container');
            container.innerHTML = '';
        };
    </script>
</body>
</html>
