<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dungeon World Chat - Sector 404</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        /* Base Styles & Mobile-First Design */
        body {
            background-color: #050505;
            color: #f0f0f0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding: 10px;
            max-width: 850px;
            margin: auto;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            transition: background-color 0.5s ease;
        }

        /* Achievement Box & Glitch Effect */
        .system-ai {
            background: linear-gradient(180deg, #990000 0%, #300000 100%);
            border: 4px solid #ff4500;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 0 30px #ff4500;
            transition: all 0.5s ease;
        }

        .glitch { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .header {
            color: #ffcc00;
            font-weight: bold;
            font-size: 1.8em;
            text-transform: uppercase;
            text-shadow: 2px 2px #000;
            line-height: 1.1;
            cursor: pointer;
            user-select: none;
            font-family: 'Share Tech Mono', monospace;
            transition: color 0.5s ease;
        }

        /* Rarity Classes */
        .rarity-common { border-color: #888; box-shadow: 0 0 15px #888; }
        .rarity-legendary { border-color: #ff8c00; box-shadow: 0 0 25px #ff8c00; }
        .rarity-celestial { border-color: #00ffff; box-shadow: 0 0 30px #00ffff; }

        .achievement {
            color: #fff;
            font-size: 1.5em;
            font-weight: bold;
            margin: 10px 0;
            border-bottom: 2px solid #ff4500;
            padding-bottom: 5px;
            font-family: 'Share Tech Mono', monospace;
            transition: border-color 0.5s ease;
        }
        .ai-snark { color: #ffa500; font-style: italic; font-weight: bold; font-size: 1.1em; line-height: 1.4; }

        /* Chat UI */
        .chat-window { border: 2px solid #444; background: rgba(20, 20, 20, 0.95); padding: 12px; min-height: 400px; transition: all 0.5s ease; }
        .chat-entry { margin-bottom: 10px; padding: 15px; border-radius: 6px; font-size: 1em; line-height: 1.5; opacity: 0; }

        /* Animation for Chat Entries */
        .fade-in {
            animation: fadeInUp 0.5s ease forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Character Colors */
        .donut { border-left: 6px solid #ff69b4; background: #2b121e; }
        .mordecai { border-left: 6px solid #00d4ff; background: #121c2b; }
        .quasar { border-left: 6px solid #ffcc00; background: #2b2512; }
        .casandra { border-left: 6px solid #00ff00; background: #122b1a; }
        .prepotente { border-left: 6px solid #fdfd96; background: #2b2b12; }
        .katia { border-left: 6px solid #00ffff; background: #122b2b; }
        .odette { border-left: 6px solid #9932cc; background: #2b122b; } 
        .elle { border-left: 6px solid #98fb98; background: #122b1b; } 
        .florin { border-left: 6px solid #daa520; background: #2b2212; } 
        .zev { border-left: 6px solid #ff1493; background: #2b121c; }

        .username { font-weight: bold; display: block; margin-bottom: 5px; text-transform: uppercase; font-size: 0.9em; font-family: 'Share Tech Mono', monospace; letter-spacing: 0.5px; }
        .donut .username { color: #ff69b4; }
        .mordecai .username { color: #00d4ff; }
        .quasar .username { color: #ffcc00; }
        .casandra .username { color: #00ff00; }
        .prepotente .username { color: #fdfd96; }
        .katia .username { color: #00ffff; }
        .odette .username { color: #9932cc; }
        .elle .username { color: #98fb98; }
        .florin .username { color: #daa520; }
        .zev .username { color: #ff1493; }

        /* Floor Status */
        .floor-status { margin-top: 25px; padding: 15px; border-left: 6px solid #ffcc00; background: #221e00; font-size: 1em; transition: all 0.5s ease; }
        .status-header { color: #ffcc00; font-weight: bold; display: block; margin-bottom: 10px; text-transform: uppercase; font-family: 'Share Tech Mono', monospace; font-size: 1.2em; }
        .status-list { list-style: none; padding: 0; margin: 0; }
        .status-list li { margin-bottom: 8px; font-family: 'Share Tech Mono', monospace; }

        /* Footer & Buttons */
        .node-footer { margin-top: 40px; border: 2px solid #00ff00; padding: 20px; text-align: center; background: #000; transition: border-color 0.5s ease; }
        .button {
            display: block; width: 100%; box-sizing: border-box; margin-top: 15px; padding: 18px;
            background-color: #00ff00; color: #000; font-weight: bold; text-decoration: none;
            text-transform: uppercase; font-size: 1.2em; border-radius: 4px; border: none; cursor: pointer;
            transition: all 0.5s ease;
            font-family: 'Share Tech Mono', monospace;
        }
        .button:active { opacity: 0.7; }
        .button:disabled { background-color: #333; color: #666; cursor: not-allowed; }

        /* Share Options Styles */
        #share-options { display: none; margin-top: 15px; }
        .share-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .share-btn { margin: 0 !important; flex: 1; min-width: 80px; padding: 12px !important; font-size: 0.9em !important; color: white !important; }

        /* Blinking Cursor for Voodoo Header */
        .blinking-cursor::after {
            content: '_';
            animation: blink 1s step-end infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* NFC Hint Style */
        .nfc-hint {
            margin-top: 20px;
            padding: 12px;
            border: 2px solid #ffcc00;
            background: #221a00;
            color: #ffcc00;
            font-weight: bold;
            text-align: center;
            font-size: 0.9em;
            animation: pulse-warning 2s infinite;
            font-family: 'Share Tech Mono', monospace;
        }
        @keyframes pulse-warning { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* Easter Egg Overlay */
        #easter-egg-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            color: #ff0000;
            font-family: 'Share Tech Mono', monospace;
            border: 5px solid #ff0000;
            box-sizing: border-box;
        }

        /* --- DONUT MODE STYLES --- */
        body.donut-theme {
            background-color: #1a0515;
            color: #ffccff;
        }

        body.donut-theme .system-ai {
            background: linear-gradient(180deg, #660033 0%, #33001a 100%);
            border-color: #ff69b4;
            box-shadow: 0 0 30px #ff69b4;
        }

        body.donut-theme .header {
            color: #ff69b4;
            text-shadow: 2px 2px #330033;
        }

        body.donut-theme .achievement {
            border-bottom-color: #ff69b4;
        }

        body.donut-theme .ai-snark {
            color: #ff99cc;
        }

        body.donut-theme .chat-window {
            border-color: #ff69b4;
            background: rgba(40, 10, 30, 0.95);
        }

        /* Override "Live System Chat" inline colors */
        body.donut-theme .username[style*="#00ff00"] {
            color: #ff69b4 !important;
        }

        /* Override Floor Status */
        body.donut-theme .floor-status {
            border-left-color: #ff69b4 !important; 
            background: #2b0015 !important;
        }

        body.donut-theme .status-header {
            color: #ff69b4 !important;
        }
        
        body.donut-theme #level-timer {
            color: #ff1493 !important;
        }

        body.donut-theme .nfc-hint {
            border-color: #ff69b4;
            background: #2a0e2a;
            color: #ff69b4;
        }

        /* Override Footer & Buttons */
        body.donut-theme .node-footer {
            border-color: #ff69b4;
        }

        body.donut-theme .node-footer strong {
            color: #ff69b4 !important;
        }

        body.donut-theme .button {
            background-color: #ff69b4 !important;
            color: #ffffff !important;
        }

        /* Override Panic Meter in Donut Mode */
        body.donut-theme #panic-bar {
            border-color: #ff69b4 !important;
        }
        body.donut-theme #panic-text {
            color: #ff69b4 !important;
        }
        body.donut-theme #gen-container {
             background: #2b0015 !important;
             border-color: #ff69b4 !important;
             border-style: dashed;
        }

        /* Override Voodoo Board in Donut Mode */
        body.donut-theme #voodoo-board-container {
             border-color: #ff69b4 !important;
        }
        body.donut-theme #voodoo-header {
             color: #ff69b4 !important;
        }
        body.donut-theme #voodoo-board-container button {
             border-color: #ff69b4 !important;
             color: #ff69b4 !important;
        }
        body.donut-theme #voodoo-board-container input,
        body.donut-theme #voodoo-board-container textarea {
             border-color: #ff69b4 !important;
             color: #ff69b4 !important;
        }
        body.donut-theme #voodoo-feed {
            border-color: #ff69b4 !important;
            color: #ffccff !important;
        }
        body.donut-theme #voodoo-feed span[style*="#ffcc00"] {
            color: #ff69b4 !important;
        }
        body.donut-theme #char-count {
            color: #ff69b4 !important;
        }

        @media (min-width: 600px) {
            body { padding: 30px; }
            .header { font-size: 2.2em; }
            .achievement { font-size: 1.8em; }
            .button { width: auto; display: inline-block; padding: 15px 40px; }
        }
    </style>
</head>
<body>
    
    <!-- Theme Toggle -->
    <button id="theme-toggle" onclick="window.toggleDonutMode()" title="Toggle Donut Mode" style="position: fixed; top: 15px; right: 15px; z-index: 999; font-size: 2em; background: none; border: none; cursor: pointer; filter: drop-shadow(0 0 5px #000);">üï∂Ô∏è</button>

    <div id="easter-egg-overlay">
        <h1 style="font-size: 3em; margin-bottom: 10px;">!!! GLITCH DETECTED !!!</h1>
        <p style="font-size: 1.5em; color: #fff;">CARL! YOU'VE UNLOCKED: GOD-TIER CRAWLER STATUS!</p>
        <p style="font-size: 1.2em; font-style: italic; color: #888; margin-top: 20px;">(Nothing actually changed. Mordecai is still disappointed.)</p>
        <button onclick="window.closeEasterEgg()" class="button" style="background: #ff0000; color: #fff; margin-top: 30px;">RESUME SIMULATION</button>
    </div>

    <div class="system-ai">
        <div class="header" onclick="window.trackHeaderTaps()">!!! NEW ACHIEVEMENT !!!</div>
        <div class="achievement" id="main-achievement-title">"CON-FLOOR SURVIVOR"</div>
        <p>YOU DID IT! You‚Äôve successfully navigated the <strong>ATLANTA SKYBRIDGE GAUNTLET</strong>! You have survived the humidity, the smell of burnt rubber and expensive polyester, and the sheer, unadulterated chaos of sixty-thousand humans trying to occupy the same square inch of hotel carpet!</p>
        <p id="main-ai-snark" class="ai-snark">REWARD: You‚Äôve received a [Platinum] Badge Ribbon! It grants you +5 to Crowd Maneuvering and -10 to Personal Space. GET BACK TO THE MESH!</p>
    </div>

    <!-- FULL CHARACTER CHAT (Dynamic) -->
    <div class="chat-window">
        <span class="username" style="color: #00ff00; display: block; margin-bottom: 10px; font-size: 1.2em;">[ LIVE SYSTEM CHAT ]</span>
        <div id="character-feed" aria-live="polite">
            <!-- JS will populate this -->
        </div>
    </div>

    <!-- LIVE STATUS BLOCK -->
    <div class="floor-status">
        <span class="status-header">[ LIVE FLOOR STATUS: SECTOR ATLANTA ]</span>
        <ul class="status-list" aria-live="polite">
            <li>‚è≥ LEVEL COLLAPSE IN: <span id="level-timer" style="color: #ff0000; font-weight: bold; font-family: 'Share Tech Mono', monospace;">CALCULATING...</span></li>
            <li id="status-row-1">üî∏ SCANNING SECTOR...</li>
            <li id="status-row-2">üî∏ SCANNING SECTOR...</li>
            <li id="status-row-3">üî∏ SCANNING SECTOR...</li>
        </ul>
    </div>

    <!-- Prepotente Panic Meter -->
    <div class="floor-status" style="border-left-color: #fdfd96; margin-top: 15px;">
        <span class="status-header">[ PREPOTENTE PANIC METER ]</span>
        <div id="panic-bar" style="height: 30px; background: #111; border: 2px solid #fdfd96; position: relative; overflow: hidden; margin-top: 10px;">
            <div id="panic-fill" style="height: 100%; background: linear-gradient(90deg, #fdfd96, #ff0000); width: 85%; transition: width 1s;"></div>
        </div>
        <p id="panic-text" style="font-size: 0.9em; margin-top: 8px; color: #fdfd96; font-weight: bold; text-transform: uppercase; font-family: 'Share Tech Mono', monospace;">‚ö†Ô∏è CURRENT STATUS: AAAAAAHHHHH!</p>
    </div>

    <!-- NFC HINT -->
    <div class="nfc-hint">
        [ SYSTEM WARNING: PROXIMITY SCAN DETECTED. TAP CHIP FOR UNSTABLE DATA UPLOAD ]
    </div>

    <div id="gen-container" class="system-ai" style="margin-top: 30px; border-style: dashed; background: #220000;">
        <div id="custom-header" class="header" style="font-size: 1.4em;">SYSTEM READY...</div>
        <div id="custom-title" class="achievement">"TAP FOR FATE"</div>
        <p id="custom-body" style="font-size: 1em;">Generate a useless achievement based on your level of survival.</p>

        <button onclick="window.generateAchievement()" class="button" style="background-color: #ff4500; color: white;">GENERATE ACHIEVEMENT</button>

        <div id="share-options">
            <p style="font-size: 0.9em; color: #ffcc00; margin-bottom: 10px; font-family: 'Share Tech Mono', monospace;">BRAG TO THE FEED:</p>
            <div class="share-grid">
                <button class="button share-btn" onclick="window.shareX()" style="background: #000;">X</button>
                <button class="button share-btn" onclick="window.shareBlueSky()" style="background: #0085ff;">BlueSky</button>
                <button class="button share-btn" onclick="window.shareThreads()" style="background: #444;">Threads</button>
                <button class="button share-btn" onclick="window.copyToClipboard(event)" style="background: #00ff00; color: #000;">Copy</button>
            </div>
        </div>
    </div>

    <!-- Voodoo Board -->
    <div class="chat-window" style="margin-top: 25px; border-color: #00ff00; margin-bottom: 25px;" id="voodoo-board-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span class="username blinking-cursor" style="color: #00ff00; margin: 0; font-size: 1.2em;" id="voodoo-header">[ VOODOO BOARD ]</span>
            <button onclick="window.loadVoodooMessages()" style="background: none; border: 1px solid #00ff00; color: #00ff00; font-size: 0.8em; padding: 4px 10px; cursor: pointer; font-family: 'Share Tech Mono', monospace;">REFRESH</button>
        </div>
        
        <div id="voodoo-feed" style="height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; background: #000; padding: 10px; font-family: 'Share Tech Mono', monospace; font-size: 1.1em; border: 1px solid #333; margin-bottom: 15px; color: #00ff00; line-height: 1.5;" aria-live="polite">
            SYSTEM: INITIALIZING VOODOO FEED...
        </div>

        <div style="display: flex; flex-direction: column; gap: 8px;">
            <input type="text" id="voodoo-name" maxlength="25" placeholder="[ CRAWLER DESIGNATION ]" style="background: #111; border: 1px solid #00ff00; color: #00ff00; padding: 14px; font-family: 'Share Tech Mono', monospace; width: 100%; box-sizing: border-box; font-size: 1.1em;">
            
            <div style="position: relative;">
                <textarea id="voodoo-msg" maxlength="150" oninput="window.updateCharCount(this)" placeholder="[ UNENCRYPTED BURST TRANSMISSION ]&#10;[ MAX 150 CHARS - KEEP IT PG OR GET ACCELERATED ]" style="background: #111; border: 1px solid #00ff00; color: #00ff00; padding: 14px; padding-bottom: 25px; font-family: 'Share Tech Mono', monospace; height: 100px; width: 100%; box-sizing: border-box; resize: none; font-size: 1.1em;"></textarea>
                <span id="char-count" style="position: absolute; bottom: 8px; right: 10px; font-size: 0.8em; color: #00ff00; font-family: 'Share Tech Mono', monospace;">150</span>
            </div>

            <button onclick="window.postToVoodoo()" class="button" style="margin: 0; padding: 16px; font-size: 1.1em;">[ BROADCAST TO SECTOR ]</button>
        </div>
    </div>

    <!-- MESH NETWORK FOOTER (MOVED TO BOTTOM) -->
    <div class="node-footer">
        <strong style="color: #00ff00; font-family: 'Share Tech Mono', monospace; font-size: 1.2em;">[ DRAGON CON MESH ACTIVE ]</strong><br>
        <span style="color: #888; font-family: 'Share Tech Mono', monospace;">NODE ID: !1fcff30a</span><br>
        <a href="https://meshtastic.org/v/#CIrmv_4BElAKCSExZmNmZjMwYRIPb2JpLXdhbi1rZW1lc2hpGgRmMzBhIgbFMx_P8wooWEIgx5cjLfBcMK-Y-ZG_cuCi_jPojvkJoYq-P1lXSvX0YHxIAA" class="button">JOIN THE MESH</a>
        <div style="margin-top: 20px;">
            <a href="mailto:hbar98@gmail.com" style="color: #666; font-family: 'Share Tech Mono', monospace; text-decoration: none; font-size: 0.9em;">[ CONTACT SYSADMIN ]</a>
        </div>
    </div>

    <script>
        window.currentTitle = "";
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx7ljyRllZ4a0OYp3B7Nrfw3Bn3QUMsXrUtJ44RlnDUk9fL8I0AyeocNrw1jXLbnDK6wg/exec';

        // Donut Mode Toggle Logic
        window.toggleDonutMode = function() {
            document.body.classList.toggle('donut-theme');
            const isDonut = document.body.classList.contains('donut-theme');
            const header = document.querySelector('.system-ai .header');
            const snark = document.querySelector('#main-ai-snark');
            const voodooHeader = document.getElementById('voodoo-header');
            
            if (isDonut) {
                header.innerText = "üëë MONGO'S FAN CLUB üëë";
                snark.innerText = "REWARD: ACCESS TO EXCLUSIVE BEHIND-THE-SCENES FOOTAGE OF ME BEING PERFECT. YOU'RE WELCOME!";
                snark.style.color = "#ff99cc";
                voodooHeader.innerText = "[ PRINCESS DONUT'S ROYAL FAN CLUB ]";
            } else {
                header.innerText = "!!! NEW ACHIEVEMENT !!!";
                // Restore random snark or default
                const randomSnark = AI_SNARKS[Math.floor(Math.random() * AI_SNARKS.length)];
                snark.innerText = `REWARD: ${randomSnark}`;
                snark.style.color = "#ffa500";
                voodooHeader.innerText = "[ VOODOO BOARD ]";
            }
        };

        // Random Snark Array
        const AI_SNARKS = [
            "Carl, stop looking at that booth. We have a schedule!",
            "THE ELEVATORS ARE STILL BROKEN, CARL!",
            "Princess Donut demands you acknowledge Mongo immediately.",
            "Prepotente is having a meltdown in 3... 2... 1...",
            "I've detected 47 people wearing the same cosplay. This is a nightmare.",
            "Carl, those aren't oats. Please stop eating the decorative potpourri.",
            "Mordecai wants you to know he's very disappointed in your choices.",
            "SYSTEM: Detecting dangerous levels of body paint and humidity.",
            "Carl, look at the feet on these people! WHY DO YOU DO THIS TO ME?!"
        ];

        // Dynamic Chat Data
        const CHAT_CHARACTERS = [
            {
                id: 'donut',
                name: 'Princess Donut Lvl 50 Queen Anne Chonk',
                lines: [
                    "CARL! MONGO IS APPALLED! WHY ARE ALL THESE PEOPLE LOOKING AT A MAN IN A SPANDEX ONESIE? TELL THE NETWORK ADMIN TO BROADCAST MY IMAGE ON EVERY SCREEN IN THE HYATT IMMEDIATELY!",
                    "CARL! I FOUND A BOOTH SELLING TIARAS, BUT THEY ARE CLEARLY INFERIOR QUALITY. MONGO TRIED TO EAT ONE. IT WAS ADORABLE.",
                    "WHY IS EVERYONE SWEATING? IT IS DISGUSTING. MORDECAI, MAKE THE AIR CONDITIONING COLDER! USE YOUR MANAGER POWERS!",
                    "CARL! THAT ROBOT JUST BEEPED AT ME! IS IT A BOMB? IT'S PROBABLY A BOMB. MONGO, DESTROY IT!",
                    "I AM THE QUEEN OF THIS CONVENTION! WHY IS THERE NO RED CARPET IN THE LOBBY? UNACCEPTABLE!",
                    "CARL! SIGNET SAYS SHE FOUND A BOOTH WITH CATNIP. WE ARE GOING THERE. NOW!",
                    "CARL! THIS PANEL ROOM IS UNFIT FOR ROYALTY! THE CHAIRS ARE PLASTIC! MORDECAI, DEMAND THEY BRING IN A THRONE IMMEDIATELY OR MONGO WILL EAT THE PROJECTOR!",
                    "OH, LOOK AT THAT PITIFUL COSPLAY OF A PRINCESS! IT'S AN INSULT TO TRUE QUEENS LIKE ME. CARL, TAKE A PHOTO SO I CAN SHOW THE VIEWERS HOW TO DO IT PROPERLY!",
                    "WHY ARE THESE HUMANS NOT BOWING? I AM PRINCESS DONUT! MONGO, DEMONSTRATE YOUR MAJESTY‚ÄîBUT DON'T STEP ON THE MERCH, IT MIGHT BE EDIBLE.",
                    "CARL! THAT BOOTH HAS SPARKLY ACCESSORIES, BUT THEY'RE FAKE GEMS! WE MUST ACQUIRE THEM ANYWAY. MORDECAI, USE YOUR MAGIC TO UPGRADE THEM TO CELESTIAL QUALITY!",
                    "THIS HUMIDITY IS RUINING MY FUR! CARL, FIND ME A FAN CLUB TO WORSHIP ME WHILE I POSE. MONGO APPROVES‚ÄîHE'S ALREADY CHEWING ON A BADGE LANYARD!"
                ]
            },
            {
                id: 'prepotente',
                name: 'Prepotente (Pony Extraordinaire)',
                lines: [
                    "AAAAAAAAAAHHHHHH! MOTHER! THE ELEVATORS ARE A BORANT CONSPIRACY! THEY WANT US TO STARVE ON THE SKYBRIDGE! AAAAAAAAAAHHHHHHH!",
                    "AAAAAAAAAAHHHHHH! THE LINE FOR BADGES IS ETERNAL! I WILL WITHER AND PERISH BEFORE I GET MY LANYARD! AAAAAAAAAAHHHHHHH!",
                    "AAAAAAAAAAHHHHHH! THAT MAN IS DRESSED AS A WOLF! HE IS A FRAUD! AAAAAAAAAAHHHHHHH!",
                    "AAAAAAAAAAHHHHHH! I HAVE EATEN A STICKER! IT TASTES OF ADHESIVE AND REGRET!",
                    "AAAAAAAAAAHHHHHH! MOTHER! THIS DEALER'S HALL IS A LABYRINTH OF DOOM! I DEMAND PREMIUM OATS AT EVERY BOOTH OR I'LL STAMPEDE THE LINE!",
                    "AAAAAAAAAAHHHHHH! THAT COSPLAYER JUST STEPPED ON MY HOOF! IT'S ASSAULT! CARL, YOU COLOSSAL DOLT, WHY DIDN'T YOU WARN ME ABOUT THESE FERAL HUMANS?",
                    "AAAAAAAAAAHHHHHH! THE WIFI IS DOWN! HOW WILL I BROADCAST MY PANIC TO THE VIEWERS? MOTHER, SAVE ME FROM THIS DIGITAL ABYSS!",
                    "AAAAAAAAAAHHHHHH! THAT PANEL ON PONIES IS FULL OF FRAUDS! MOTHER, THEY DON'T UNDERSTAND TRUE EQUINE EXCELLENCE LIKE ME!"
                ]
            },
            {
                id: 'katia',
                name: 'Katia (Level 42 Tank)',
                lines: [
                    "Carl, I‚Äôve found a path through the food court, but it‚Äôs guarded by a Level 60 'Line for Pizza.' We need to use this mesh node to coordinate the bypass!",
                    "I just saw a crawler dual-wielding light sabers. I don't think that's in the rulebook, Carl. Should we be worried?",
                    "My map says the panel is in this room, but it's just a closet full of chairs. Is this a trap?",
                    "I think I just accidentally joined a cult in the gaming hall. They gave me a ribbon.",
                    "Carl, the skybridge is a chokepoint‚ÄîLevel 50 'Crowd Surge' ahead. We could flank via the stairs, but watch for that rogue escalator trap.",
                    "I spotted a group stuck in the badge pickup line; it's like a bubble quest. Should we coordinate a rescue with the mesh? I don't want to leave them behind.",
                    "My badge says the art alley is clear, but it's probably a mimic booth. Carl, let's test it with a probe‚Äîmaybe throw a free sticker?",
                    "Accidentally joined a LARP group in the lobby; they thought my tank build was cosplay. Now I'm committed‚Äîanyone got tips for improvising a shield from a program booklet?",
                    "This humidity debuff is stacking; we need a hydration station bypass. Carl, your explosive feet might clear a path, but let's not blow up the con-crud vendors."
                ]
            },
            {
                id: 'mordecai',
                name: 'Mordecai (Manager)',
                lines: [
                    "Stop screaming! Prepotente, the elevators have been broken since the tenth floor. Crawler, keep that signal steady! We need a clear link before the Skybridge becomes a total chokepoint.",
                    "Donut, for the last time, you cannot join the parade. You are a cat. Carl, focus on the objective. We need to find the charging station.",
                    "If I see one more person doing the Macarena, I'm going to have an aneurysm. Keep moving, Crawlers.",
                    "Drink water. I don't want to have to explain to the showrunners why my crawlers passed out in a fur suit.",
                    "Donut, no, you can't demand a parade float‚Äîthat's a ratings trap. Focus on the objective: find the saferoom booth before the fire marshal shuts it down.",
                    "If I have to explain one more time why overpriced con snacks aren't potions... Drink your water, crawlers, or I'll brew something that'll make you regret it.",
                    "Prepotente, calm your panic‚Äîthe elevators are a known hazard since floor one. Stick to the plan, or you'll end up like my brother: lost in the chaos.",
                    "You can't save every lost cosplayer, Carl. But... fine, let's reroute. Just don't tell Odette; she'd turn it into a drama episode.",
                    "This mesh network is unstable‚Äîreminds me of that cursed guild on floor five. Keep signals low, or we'll attract the wrong kind of attention."
                ]
            },
            {
                id: 'quasar',
                name: 'Quasar (Legal Counsel/Certified Genius)',
                lines: [
                    "CHOKEPOINT? I‚Äôll sue the very concept of occupancy! I‚Äôll sue the bricks! CRAWLER, YOUR RIGHT TO STAND HERE IS PROTECTED!",
                    "Overpriced water? That's extortion! I'll file a class-action lawsuit against hydration itself! I'll sue the molecule!",
                    "They wouldn't let me into the VIP lounge? I'll buy the lounge! Then I'll sue the bouncer for emotional distress!",
                    "This badge requires a waiver? I don't sign waivers, I rewrite them! I OWN THE FINE PRINT!",
                    "BADGE LINE TOO LONG? THAT'S A VIOLATION OF CRAWLER RIGHTS! I'LL SUE THE CONVENTION CENTER, THE VOLUNTEERS, AND TIME ITSELF!",
                    "This overpriced swag? Extortion! I'll file against the vendors, the economy, and the concept of capitalism‚Äîyour loot is protected, crawler!",
                    "They banned my briefcase in the panel room? I'll acquire the whole hotel! Then sue the security for infringing on my genius!",
                    "Humidity clause in the terms? I didn't sign that! I'll rewrite the weather contract and sue the clouds for emotional damages!",
                    "No VIP access? Unacceptable! I'll litigate the hierarchy, buy the elite lounge, and countersue gravity for holding us down!"
                ]
            },
            {
                id: 'casandra',
                name: 'Casandra (Exasperated Operations)',
                lines: [
                    "EVERYONE SHUT UP! Crawler, keep the mesh open. If I lose my tactical overview, I will personally rewrite your respawn protocol!",
                    "I am tracking 50,000 entities in this sector and they are all moving randomly. It's tactical suicide. Maintain formation!",
                    "Who unauthorized this broadcast? Actually, never mind. Just keep the signal up. I need to monitor the buffet line.",
                    "If one more person asks me where the bathroom is, I'm going to start venting atmosphere.",
                    "QUIET, ALL OF YOU! Crawler, maintain the perimeter‚ÄîI've got 60,000 entities on radar, and they're all converging on the autograph line. Formation now!",
                    "Who greenlit this parade route? It's a tactical nightmare! Signal the bypass, or I'll vent the entire skybridge myself.",
                    "Another elevator outage? Unauthorized! Keep the mesh stable‚ÄîI need eyes on the food court before it turns into a battlefield.",
                    "If one more crawler asks for directions to the bathroom, I'll rewrite the floor map! Focus on survival, not side quests!",
                    "Tracking cosplay mobs‚Äîrandom movement patterns. Hold position, or this sector becomes a respawn zone. Shut up and listen!"
                ]
            },
            {
                id: 'odette',
                name: 'Odette (Showrunner)',
                lines: [
                    "Ratings are down in the Vendor Hall. Spice it up! Maybe start a small fire? Just a little one.",
                    "Who authorized that cosplay? It infringes on Borant copyright. I want names!",
                    "I need more drama in the food court! Someone flip a table! The viewers are bored!",
                    "Look at those engagement numbers! The 'Elevator Failure' arc is testing really well with the Valtay.",
                    "Viewer numbers dipping in the gaming hall? Let's amp it‚Äîstart a flash mob or a fake feud. The Valtay eat up that chaos!",
                    "That elevator jam is gold for the 'Survival Arc'! Keep it rolling‚Äîwho authorized the fix? I need more suffering for the highlights!",
                    "Cosplay infringement? Perfect scandal! Get names, flip a table if needed‚Äîthe engagement from outrage is chef's kiss.",
                    "Bored in the vendor hall? Ignite a small bidding war‚Äîjust enough fire for ratings. Remember, the longer the drama, the bigger my payout!",
                    "Look at those skybridge stats! The 'Humidity Hell' episode is trending. Push the crawlers harder‚Äîviewers love a breakdown!"
                ]
            },
            {
                id: 'elle',
                name: 'Elle',
                lines: [
                    "Well hello there, tall, dark, and armored. Care to share a potion?",
                    "I saw a barbarian in the lobby who could definitely crush a melon. I'm intrigued.",
                    "My feet hurt, but this outfit is worth the pain. Stop staring... actually, don't stop.",
                    "Anyone want to help me find some trouble? The fun kind, obviously.",
                    "Yo, barkeep at the con bar! Whose ass do I gotta freeze to get a shot? This humidity's meltin' my icicles‚Äîgimme somethin' strong!",
                    "Saw a hunk in armor by the elevators‚Äîhey, tall and sweaty, wanna share a potion? My feet are killin' me, but the view's worth it.",
                    "You mess with Carl's crew, I'll shatter your badge like glass! Come at us, and your blood turns to slush‚Äînow who's buyin' the next round?",
                    "This outfit's hot as hell, but damn if it don't turn heads. Stop starin'... or don't, I could use the ego boost after that line wait.",
                    "Accidentally iced a pushy vendor‚Äîoops, no remorse! Barry'd laugh; now, anyone up for trouble? The drunk kind, obviously."
                ]
            },
            {
                id: 'florin',
                name: 'Florin',
                lines: [
                    "Oi! Watch your back in the dealer's room, mates. It's a bloody shark tank in there.",
                    "Reckon we bypass the shuttle line. It's chock-a-block. We walk.",
                    "Don't be a drongo. That 'free' sample is definitely trapped.",
                    "Fair dinkum, the prices at the food court are daylight robbery. Who's got rations?",
                    "Oi, mates, that shuttle queue's a bloody ambush‚Äîchockers with traps. Let's leg it; no drongo waits for that nonsense.",
                    "Watch yer six in the panel room; smells like a setup. If ya need backup, I'm in‚Äîdebts paid with bullets, yeah?",
                    "Fair dinkum, this con's prices are robbery. Who's packin' rations? Can't fight on empty, especially after losin' my ray of light.",
                    "That cosplay mob's dodgy‚Äîwrapped 'round the buildin'. Bypass it, or we'll wither like I almost did. For Ife, we push on.",
                    "Broodin' over the skybridge chaos‚Äîreminds me of lost mates. But Carl, ya pulled me back; need a gun? I'm yers."
                ]
            },
            {
                id: 'zev',
                name: 'Zev (Marketing)',
                lines: [
                    "We're live in 5! Look heroic! Flex something! The outer systems are watching!",
                    "The sponsors love the spandex look! Can you strike a pose near the trash can? It's 'gritty'.",
                    "Can we get a close up on that badge? It's shiny! Shiny things poll well with the kuo-toa!",
                    "Donut! The camera loves you! Ignore the goblin, look at the lens!",
                    "Live in 5, crawlers! Strike a pose by that booth‚Äîthe sponsors adore the chaos aesthetic. Flex for the outer systems!",
                    "Donut, the camera's obsessed with you! Ignore the line wait; look fierce‚Äîshiny badges poll huge with the kuo-toa viewers!",
                    "Ratings spiking on the elevator fail! Can we get a gritty shot near the trash? It's trending‚Äîkeep surviving for that mutual win!",
                    "We're golden on engagement‚Äîthe 'Con-Crud Arc' is hot. Listen up: follow my lead, or the AI notices. Gossip Girl collab post-crawl?",
                    "Focus group loves the humidity drama! Pose heroic, ignore the goblin cosplay‚Äîviewers eat it up. You're stars; don't die on me!"
                ]
            }
        ];

        window.headerTapCount = 0;
        window.tapTimer = null;

        window.trackHeaderTaps = function() {
            window.headerTapCount++;
            clearTimeout(window.tapTimer);
            if (window.headerTapCount >= 5) {
                window.triggerEasterEgg();
                window.headerTapCount = 0;
            } else {
                window.tapTimer = setTimeout(() => { window.headerTapCount = 0; }, 2000);
            }
        };

        window.triggerEasterEgg = function() {
            document.body.classList.add('glitch');
            document.getElementById('panic-fill').style.width = '100%';
            document.getElementById('panic-text').innerText = "‚ö†Ô∏è SYSTEM CRITICAL: CARL IS CHEATING!";
            document.getElementById('easter-egg-overlay').style.display = 'flex';
        };

        window.closeEasterEgg = function() {
            document.body.classList.remove('glitch');
            document.getElementById('easter-egg-overlay').style.display = 'none';
            window.initPanicMeter();
        };

        window.chatInterval = null;
        
        window.initChatCycle = function() {
            const container = document.getElementById('character-feed');
            container.innerHTML = ''; 
            
            // Initial fill
            for(let i=0; i<4; i++) {
                window.addChatMessage();
            }

            if (window.chatInterval) clearInterval(window.chatInterval);
            window.chatInterval = setInterval(window.addChatMessage, 9000);
        };

        window.addChatMessage = function() {
            const container = document.getElementById('character-feed');
            // Use random chat line logic
            const char = CHAT_CHARACTERS[Math.floor(Math.random() * CHAT_CHARACTERS.length)];
            const line = char.lines[Math.floor(Math.random() * char.lines.length)];
            
            const entry = document.createElement('div');
            entry.className = `chat-entry ${char.id} fade-in`;
            entry.innerHTML = `<span class="username">${char.name}</span>${line}`;
            
            container.appendChild(entry);
            
            // Limit to 5 visible messages
            if (container.children.length > 5) {
                container.removeChild(container.firstChild);
            }
        };

        window.onload = function() {
            // Apply random snark
            const randomSnark = AI_SNARKS[Math.floor(Math.random() * AI_SNARKS.length)];
            document.getElementById('main-ai-snark').innerText = `REWARD: ${randomSnark}`;

            // Generate Dynamic Chat
            window.initChatCycle();

            // Init Dynamic Statuses
            setTimeout(function() {
                window.loadVoodooMessages();
                // Refresh Voodoo every 30 seconds
                setInterval(window.loadVoodooMessages, 30000);
                
                window.initPanicMeter();
                window.initLiveStats();
            }, 500);
        };

        // Panic Meter Logic
        window.panicInterval = null;
        window.initPanicMeter = function() {
            if (window.panicInterval) clearInterval(window.panicInterval);
            const fill = document.getElementById('panic-fill');
            const text = document.getElementById('panic-text');
            
            // Expanded pool of panic statuses
            const statuses = [
                "AAAAAAHHHHH!",
                "ELEVATOR SABOTAGE!",
                "OATS DEPLETION!",
                "MOTHERRR!",
                "UNACCEPTABLE!",
                "CONTROLLED SOBBING",
                "THE SKYBRIDGE IS A TRAP!",
                "WHERE IS MY LANYARD?!",
                "TOO MANY PEOPLE!",
                "I REQUIRE PREMIUM OATS!",
                "THE CARPET IS MOVING!",
                "DIGNITY CRITICAL!"
            ];

            window.panicInterval = setInterval(() => {
                // Range 60% to 100% for visible movement
                const newWidth = Math.floor(Math.random() * (100 - 60 + 1)) + 60;
                fill.style.width = newWidth + '%';
                
                // Pick a random status every time
                const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
                text.innerText = `‚ö†Ô∏è CURRENT STATUS: ${randomStatus}`;

                // Color logic based on width
                if (newWidth > 90) {
                    text.style.color = "#ff0000"; // Red
                    fill.style.background = "linear-gradient(90deg, #ff4500, #ff0000)";
                } else if (newWidth < 75) {
                    text.style.color = "#fdfd96"; // Yellow
                    fill.style.background = "linear-gradient(90deg, #fdfd96, #ffcc00)";
                } else {
                    text.style.color = "#ff8c00"; // Orange
                    fill.style.background = "linear-gradient(90deg, #ffcc00, #ff4500)";
                }
            }, 3000);
        };

        // Live Stats Logic (Dynamic Status Lines)
        window.statsInterval = null;
        window.statusRotationInterval = null;
        
        window.initLiveStats = function() {
            if (window.statsInterval) clearInterval(window.statsInterval);
            if (window.statusRotationInterval) clearInterval(window.statusRotationInterval);

            // Pool of random statuses
            const statusPool = [
                { label: "ELEVATORS", value: "[CRITICAL FAILURE]", color: "#ff0000" },
                { label: "ELEVATORS", value: "FULL. ALWAYS FULL.", color: "#ffcc00" },
                { label: "TEMPERATURE", value: "SURFACE OF THE SUN", color: "#ff4500" },
                { label: "HUMIDITY", value: "SWAMP CONDITIONS", color: "#00ccff" },
                { label: "ROOM LINE", value: "ETERNAL", color: "#ff0000" },
                { label: "ROOM LINE", value: "WRAPPED AROUND BUILDING", color: "#ffcc00" },
                { label: "CURRENT BOSS", value: "THE FIRE MARSHAL", color: "#ff0000" },
                { label: "CURRENT BOSS", value: "3AM WAFFLE HOUSE", color: "#ffcc00" },
                { label: "CURRENT BOSS", value: "THE SUN", color: "#ffcc00" },
                { label: "SECTOR POP", value: "85,420 [OVERCROWDED]", color: "#ffcc00" },
                { label: "AIR QUALITY", value: "CON-CRUD DETECTED", color: "#00ff00" },
                { label: "HYDRATION", value: "PIZZA IS NOT WATER", color: "#00ccff" },
                { label: "SHUTTLE", value: "LOST IN THE VOID", color: "#ff0000" },
                { label: "CARPET", value: "DO NOT STARE", color: "#cc00ff" },
                { label: "VIBE", value: "SCREAMING", color: "#ff0000" },
                { label: "VIBE", value: "CHAOTIC GOOD", color: "#00ff00" },
                { label: "COSTUME", value: "HOT GLUE FAILURE", color: "#ffcc00" },
                { label: "BADGE LINE", value: "CIRCLING THE BLOCK", color: "#ff0000" },
                { label: "SLEEP", value: "OPTIONAL", color: "#00ccff" }
            ];

            const updateStatuses = () => {
                // Shuffle and pick 3 unique items
                const shuffled = [...statusPool].sort(() => 0.5 - Math.random());
                const selected = shuffled.slice(0, 3);
                
                for(let i=0; i<3; i++) {
                    const el = document.getElementById(`status-row-${i+1}`);
                    if(el) {
                        el.innerHTML = `üî∏ ${selected[i].label}: <span style="color: ${selected[i].color}; font-weight: bold;">${selected[i].value}</span>`;
                    }
                }
            };

            // Run immediately and then rotate every 12 seconds
            updateStatuses();
            window.statusRotationInterval = setInterval(updateStatuses, 12000);

            // Level Collapse Timer Logic (Labor Day 5PM)
            const timerEl = document.getElementById('level-timer');
            const now = new Date();
            const year = now.getFullYear();
            
            // Calculate Labor Day (1st Monday of Sept)
            let laborDay = new Date(year, 8, 1); 
            while (laborDay.getDay() !== 1) {
                laborDay.setDate(laborDay.getDate() + 1);
            }
            laborDay.setHours(17, 0, 0, 0);

            // If passed, target next year
            if (now > laborDay) {
                laborDay.setFullYear(year + 1);
                laborDay.setMonth(8);
                laborDay.setDate(1);
                while (laborDay.getDay() !== 1) {
                    laborDay.setDate(laborDay.getDate() + 1);
                }
                laborDay.setHours(17, 0, 0, 0);
            }

            window.statsInterval = setInterval(() => {
                const currentTime = new Date().getTime();
                const distance = laborDay.getTime() - currentTime;

                if (distance < 0) {
                    timerEl.innerText = "COLLAPSE IMMINENT";
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                timerEl.innerText = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            }, 1000);
        };

        window.generateAchievement = function() {
            const adjectives = ["Legendary", "Decrepit", "Glistening", "Appalled", "Celestial", "Malfunctioning", "Stinky", "Exasperated", "Unhinged", "Copyright-Infringing", "God-Tier", "Sticky", "Slime-Covered", "Aggressive"];
            const nouns = ["Skybridge", "Tiara", "Oats", "Packet", "Llama", "Cosplayer", "Holocron", "Badge", "Elevator", "Con-Crud", "Foot-Photo", "Vendor-Hall", "Service-Lift"];
            const verbsPast = ["wrangled", "evaded", "glurped", "sued", "screamed at", "infiltrated", "buffered", "ignored", "acquired", "over-clocked", "petted", "dismantled"];
            const verbsIng = ["wrangling", "evading", "glurping", "suing", "screaming at", "infiltrating", "buffering", "ignoring", "acquiring", "over-clocking", "petting", "dismantling"];

            const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
            const roll = Math.floor(Math.random() * verbsPast.length);

            const adj = pick(adjectives);
            const noun = pick(nouns);
            const vPast = verbsPast[roll];
            const vIng = verbsIng[roll];

            const article = /^[aeiou]/i.test(adj) ? "an" : "a";
            const isPlural = ["Oats"].includes(noun);
            const fullNoun = isPlural ? `${adj} ${noun}` : `${article} ${adj} ${noun}`;

            const bodies = [
                `You have ${vPast} ${fullNoun} in a way that makes the AI very uncomfortable.`,
                `Against all odds, you successfully ${vPast} ${fullNoun} without causing a sector-wide reset.`,
                `By ${vIng} ${fullNoun}, you have officially peaked. It's all downhill from here.`,
                `The AI noticed you ${vPast} ${fullNoun}. It's currently writing a creepy poem about it.`,
                `You just ${vPast} ${fullNoun}. Mordecai is sighing so hard he might pass out.`
            ];

            let reward = "A Common Quality Cotton Sock.";
            if (noun === "Tiara") reward = "Princess Donut's grudging respect.";
            else if (noun === "Oats") reward = "10 seconds of silence from Prepotente.";
            else if (noun === "Foot-Photo") reward = "A [God-Tier] digital framing kit.";
            else reward = pick(["Priority Elevator Access (Still Broken).", "A Signed Photo of Mongo.", "+5 to Humidity Resistance.", "A commemorative pin that says 'I Tried'."]);

            const container = document.getElementById('gen-container');
            container.classList.remove('glitch', 'rarity-common', 'rarity-legendary', 'rarity-celestial');
            void container.offsetWidth; 
            container.classList.add('glitch');

            const rarity = pick(["rarity-common", "rarity-legendary", "rarity-celestial"]);
            container.classList.add(rarity);

            window.currentTitle = `${adj} ${noun}`;
            document.getElementById('custom-header').innerText = "NEW ACHIEVEMENT!";
            document.getElementById('custom-title').innerText = `"${window.currentTitle}"`;
            document.getElementById('custom-body').innerText = `${pick(bodies)}\n\nREWARD: ${reward}`;
            document.getElementById('share-options').style.display = 'block';
        };

        window.getShareText = function() {
            return `I just earned the "${window.currentTitle}" achievement at Dragon Con! Don't tell Mordecai: hbar98.github.io #DragonCon #DCC`;
        };

        window.shareX = function() { window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(window.getShareText())}`, '_blank'); };
        window.shareBlueSky = function() { window.open(`https://bsky.app/intent/compose?text=${encodeURIComponent(window.getShareText())}`, '_blank'); };
        window.shareThreads = function() { window.open(`https://www.threads.net/intent/post?text=${encodeURIComponent(window.getShareText())}`, '_blank'); };

        window.copyToClipboard = function(e) {
            if (!navigator.clipboard) {
                const textArea = document.createElement("textarea");
                textArea.value = window.getShareText();
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const btn = e.target;
                    const originalText = btn.innerText;
                    btn.innerText = "COPIED!";
                    setTimeout(() => { btn.innerText = originalText; }, 2000);
                } catch (err) {}
                document.body.removeChild(textArea);
                return;
            }
            navigator.clipboard.writeText(window.getShareText()).then(() => {
                const btn = e.target;
                const originalText = btn.innerText;
                btn.innerText = "COPIED!";
                setTimeout(() => { btn.innerText = originalText; }, 2000);
            });
        };

        // Enhanced Profanity Filter
        window.sanitize = function(str) {
            if (!str) return "";
            let clean = str.replace(/<\/?[^>]+(>|$)/g, "");
            
            // Enhanced word list with common variants and leetspeak
            const blockedWords = [
                "fuck", "fuk", "fck", "f u c k", "sh!t", "shit", "sh1t", "bitch", "b!tch", "b1tch",
                "cunt", "twat", "wank", "pussy", "dick", "d1ck", "cock", "penis", "vagina",
                "asshole", "a$$hole", "bastard", "slut", "whore",
                "nazi", "n@zi", "racist", "fag", "f@g", "nigger", "nigga", "n1gger", "kike", "spic",
                "retard", "r3tard", "chink", "tranny", "shemale", "dyke", "gook", "beaner", "coon",
                "rapist", "pedophile", "pedo", "pdf file", "PDF file"
            ];
            
            blockedWords.forEach(word => {
                // Case-insensitive and catches variations with spaces/symbols
                const regex = new RegExp(word.split('').join('[\\s\\W]*'), "gi");
                clean = clean.replace(regex, "[REDACTED]");
            });
            
            // Enforce length limit
            return clean.trim().substring(0, 150);
        };

        window.updateCharCount = function(textarea) {
            const remaining = 150 - textarea.value.length;
            const counter = document.getElementById('char-count');
            counter.innerText = remaining;
            counter.style.color = remaining < 20 ? '#ff0000' : '#00ff00';
        };

        window.loadVoodooMessages = function() {
            const feed = document.getElementById('voodoo-feed');
            
            // Don't wipe the feed if it already has content, to prevent flickering
            if(feed.children.length === 0 || feed.innerText.includes('SYSTEM:')) {
                 feed.innerHTML = 'SYSTEM: ACCESSING VOODOO STREAM...';
            }

            const cacheBuster = SCRIPT_URL + (SCRIPT_URL.includes('?') ? '&' : '?') + 't=' + new Date().getTime();
            fetch(cacheBuster, { method: "GET", redirect: "follow" })
            .then(res => {
                if (!res.ok) throw new Error('Network response not ok');
                return res.json();
            })
            .then(data => {
                // Clear and rebuild
                feed.innerHTML = '';
                if (data && Array.isArray(data)) {
                    data.reverse().forEach(row => {
                        const entry = document.createElement('div');
                        entry.style.marginBottom = "15px";
                        entry.style.borderBottom = "1px solid #222";
                        entry.style.paddingBottom = "8px";
                        const displayName = window.sanitize(row[1] || 'Unknown Designation');
                        const displayMsg = window.sanitize(row[2] || 'Empty Transmission');
                        entry.innerHTML = `<span style="color: #ffcc00; font-size: 0.9em; font-weight: bold;">[${displayName}]</span><br>${displayMsg}`;
                        feed.appendChild(entry);
                    });
                    if (data.length === 0) feed.innerHTML = 'SYSTEM: NO TRANSMISSIONS FOUND.';
                }
            })
            .catch(err => {
                console.error("Voodoo Load Error:", err);
                // Only show error if feed is empty
                if(feed.children.length === 0) {
                    feed.innerHTML = 'SYSTEM ERROR: CONNECTION INTERRUPTED.<br><br>Check browser console or verify Google Script deployment.';
                }
            });
        };

        window.postToVoodoo = function() {
            const nameField = document.getElementById('voodoo-name');
            const msgField = document.getElementById('voodoo-msg');
            const name = window.sanitize(nameField.value) || 'Anonymous';
            const message = window.sanitize(msgField.value);
            if (!message) return;
            const btn = document.querySelector('button[onclick="window.postToVoodoo()"]');
            const originalText = btn.innerText;
            btn.innerText = "[ TRANSMITTING... ]";
            btn.disabled = true;
            const formData = new URLSearchParams();
            formData.append('name', name);
            formData.append('message', message);
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData.toString()
            })
            .then(() => {
                msgField.value = '';
                // Reset char count
                document.getElementById('char-count').innerText = '150';
                btn.innerText = "[ BROADCAST SUCCESS ]";
                setTimeout(window.loadVoodooMessages, 2000);
                setTimeout(() => { 
                    btn.innerText = originalText; 
                    btn.disabled = false;
                }, 4000);
            })
            .catch(err => {
                console.error("Voodoo Post Error:", err);
                btn.innerText = "[ TRANSMISSION FAILED ]";
                btn.disabled = false;
                setTimeout(() => { btn.innerText = originalText; }, 3000);
            });
        };
    </script>
</body>
</html>
